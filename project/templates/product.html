{% extends "base.html" %}
{% block title %}{{ produit.name }} - Digital Adept{% endblock %}
{% block content %}

<section class="product-page">
  <!-- Barre du panier -->
  <div id="cart-bar" class="hidden">
      <div id="cart-header">
          <h3>Votre panier</h3>
          <button id="close-cart">‚úò</button>
      </div>
      <div id="cart-items"></div>
      <div id="cart-footer">
          <p>Total : <span id="cart-total" data-price="0" data-currency="XOF">0</span></p>
          <button id="buy-from-cart">Acheter maintenant</button>
      </div>
  </div>

  <!-- 1) HERO (dynamique avec fallback) -->
  <section class="product-hero">
    <div class="hero-content">
      <h1 class="hero-title">
        {{ produit.hero_title or "Prenez le contr√¥le de vos finances d√®s aujourd‚Äôhui" }}
      </h1>
      <p class="hero-subtitle">
        {{ produit.hero_subtitle or produit.short_description or "Un planificateur simple, visuel et puissant pour g√©rer votre budget mensuel et annuel" }}
      </p>
      <div class="hero-cta">
        <button class="btn btn-buy"
                data-name="{{ produit.name }}"
                data-price="{{ produit.price }}">
          {{ produit.hero_cta_label or "T√©l√©charger maintenant" }}
        </button>
      </div>
    </div>
    <div class="hero-visual">
      {% set visual = (produit.images[0].url if produit.images else url_for('static', filename='img/logo.webp')) %}
      <img src="{{ visual }}" alt="{{ produit.name }}" class="hero-mockup" loading="eager">
    </div>
  </section>

  <!-- 2) BENEFICES (dynamique avec fallback) -->
  <section class="product-benefits">
    <ul class="benefits-list">
      {% if produit.benefits and produit.benefits|length > 0 %}
        {% for b in produit.benefits %}
          {% set txt = (b.text if b is mapping and b.get('text') else (b if b is string else b)) %}
          <li class="benefit-item">{{ txt }}</li>
        {% endfor %}
      {% else %}
        <li class="benefit-item">üí° Visualisez vos d√©penses en un coup d‚Äô≈ìil</li>
        <li class="benefit-item">üìà Suivez vos progr√®s mois apr√®s mois</li>
        <li class="benefit-item">üßò R√©duisez votre stress financier</li>
        <li class="benefit-item">üîí Acc√®s instantan√©, s√©curis√© et √† vie</li>
      {% endif %}
    </ul>
  </section>

  <!-- 3) DEMO VIDEO (optionnelle) -->
  {% if produit.demo_video_url %}
  <section class="video-promo-section">
    <h2>Le produit en action</h2>
    <div class="video-promo-flex">
      <div class="video-promo-player">
        <iframe
          src="{{ produit.demo_video_url }}"
          title="D√©monstration"
          loading="lazy"
          allowfullscreen></iframe>
      </div>
      <div class="video-promo-text">
        {{ produit.demo_video_text or "D√©couvrez rapidement comment l‚Äôoutil fonctionne et ce que vous allez obtenir." }}
      </div>
    </div>
  </section>
  {% endif %}

  <!-- Galerie + D√©tails/achat -->
  <div class="product-container">
    <!-- Galerie -->
    <div class="product-gallery">
      <div class="gallery-main">
        <div class="gallery-images">
        {% for img in produit.images %}
          {% if img is string %}{% set url = img %}{% else %}{% set url = img.url %}{% endif %}
          {% set base = url.split('/')[-1].rsplit('.', 1)[0] %}
          <picture>
            <source
              srcset="
                https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/{{ base }}-400.webp 400w,
                https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/{{ base }}-800.webp 800w,
                https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/{{ base }}-1200.webp 1200w
              " type="image/webp"
              sizes="(max-width:600px) 400px, (max-width:1100px) 800px, 1200px">
            <source
              srcset="
                https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/{{ base }}-400.jpg 400w,
                https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/{{ base }}-800.jpg 800w,
                https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/{{ base }}-1200.jpg 1200w
              " type="image/jpeg"
              sizes="(max-width:600px) 400px, (max-width:1100px) 800px, 1200px">
            <img src="https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/{{ base }}-800.jpg"
                 alt="{{ produit.name }}"
                 class="gallery-img{% if loop.first %} active{% endif %}"
                 width="800" height="533">
          </picture>
        {% endfor %}
        </div>
        {% if produit.images and produit.images|length > 1 %}
          <button class="gallery-arrow left" aria-label="Image pr√©c√©dente">&#8249;</button>
          <button class="gallery-arrow right" aria-label="Image suivante">&#8250;</button>
        {% endif %}
      </div>
      {% if produit.images and produit.images|length > 1 %}
      <div class="gallery-thumbnails">
        {% for img in produit.images %}
          {% if img is string %}{% set url = img %}{% else %}{% set url = img.url %}{% endif %}
          {% set base = url.split('/')[-1].rsplit('.', 1)[0] %}
          <picture>
            <source srcset="https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/{{ base }}-400.webp" type="image/webp">
            <source srcset="https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/{{ base }}-400.jpg" type="image/jpeg">
            <img src="https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/{{ base }}-400.jpg"
                 alt="Miniature {{ loop.index }}"
                 class="gallery-thumb{% if loop.first %} active{% endif %}"
                 width="80" height="53" loading="lazy">
          </picture>
        {% endfor %}
      </div>
      {% endif %}
      <div class="gallery-zoom-hint">Survolez ou touchez pour zoomer</div>
    </div>

    <!-- D√©tails + achat -->
    <div class="product-details">
      <!-- Badges dynamiques -->
      <div class="product-badges-detailed">
        {% if produit.old_price and produit.old_price > produit.price %}
          {% set discount = ((produit.old_price - produit.price) / produit.old_price * 100) | round | int %}
          <span class="badge badge-promo">{{ discount }}% OFF</span>
        {% endif %}
        {% for badge in produit.badges %}
          <span class="badge badge-{{ badge.type|lower }}">{{ badge.text }}</span>
        {% endfor %}
      </div>

      <h1 class="product-title">{{ produit.name }}</h1>

      <!-- Notation interactive -->
      <div id="product-rating-interactive" class="product-rating"
           data-product-id="{{ produit.id }}"
           data-initial-rating="{{ rating|default(0) }}"
           data-initial-reviews="{{ reviews_count|default(0) }}">
        <div class="stars-interactive">
          {% for i in range(1, 5+1) %}
          <button class="star-btn" type="button" data-value="{{ i }}" aria-label="Noter {{ i }} sur 5">
            <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
          </button>
          {% endfor %}
        </div>
        <div class="rating-summary">
          <span class="rating-value">
            {% if reviews_count > 0 %}{{ "%.1f"|format(rating) }}/5{% else %}(Non not√©){% endif %}
          </span>
          <span class="review-count">{% if reviews_count > 0 %}‚Äì {{ reviews_count }} avis{% endif %}</span>
        </div>
      </div>

      <!-- Prix -->
      <div class="product-price-detailed">
        <span class="current-price" data-price="{{ produit.price }}" data-currency="{{ produit.currency }}">{{ produit.price }} {{ produit.currency }}</span>
        {% if produit.old_price %}
          <span class="old-price" data-price="{{ produit.old_price }}" data-currency="{{ produit.currency }}">{{ produit.old_price }} {{ produit.currency }}</span>
        {% endif %}
      </div>

      <!-- Stock + R√©f√©rence -->
      <div class="product-stock">
        {% if produit.stock > 0 %}<span class="in-stock">Disponible</span>{% else %}<span class="out-stock">Indisponible</span>{% endif %}
      </div>
      {% if produit.sku %}
      <div class="reference">R√©f√©rence : {{ produit.sku }}</div>
      {% endif %}

      <!-- R√©sum√© court -->
      <div class="product-short-desc">
        {{ produit.short_description or produit.description|striptags|truncate(120) }}
      </div>

      <!-- Boutons -->
      <div class="product-meta">
        <div class="product-buttons">
          <button class="btn btn-buy" data-name="{{ produit.name }}" data-price="{{ produit.price }}">
            {{ produit.hero_cta_label or "T√©l√©charger maintenant" }}
          </button>
          <button class="btn btn-cart add-to-cart" data-id="{{ produit.id }}" data-name="{{ produit.name }}" data-price="{{ produit.price }}">
            Ajouter au panier
          </button>
          <button class="btn btn-share" id="share-btn">Partager</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 4) CE QUE VOUS RECEVEZ (dynamique) -->
  <section class="product-includes">
    <h2>Ce que vous recevez</h2>
    <ul class="includes-list">
      {% if produit.includes and produit.includes|length > 0 %}
        {% for inc in produit.includes %}
          {% set txt = (inc.text if inc is mapping and inc.get('text') else (inc if inc is string else inc)) %}
          <li>‚úÖ {{ txt }}</li>
        {% endfor %}
      {% else %}
        <li>‚úÖ Mod√®le Google Sheets/Excel</li>
        <li>‚úÖ Guide PDF d‚Äôutilisation</li>
        <li>‚úÖ Support WhatsApp inclus</li>
      {% endif %}
    </ul>
  </section>

  <!-- 5) TEMOIGNAGES (bas√© sur comments d√©j√† dynamiques) -->
  {% set testimonials = comments|selectattr('comment')|list %}
  {% if testimonials and testimonials|length > 0 %}
  <section class="product-testimonials">
    <h2>Ils en parlent</h2>
    <div class="testimonials-grid">
      {% for c in testimonials[:3] %}
      <div class="testimonial-card">
        <div class="testimonial-header">
          <div class="avatar">{{ (c.comment[:1] or 'U')|upper }}</div>
          <div class="meta">
            <div class="name">Client</div>
            <div class="note">‚≠ê {{ c.rating or 5 }}/5</div>
          </div>
        </div>
        <p class="content">{{ c.comment }}</p>
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <!-- 6) FAQ (d√©j√† dynamique via produit.faqs, fallback fourni) -->
  <section class="product-faq">
    <h2>Questions fr√©quentes</h2>
    <div class="product-faq-container">
      {% if produit.faqs and produit.faqs|length > 0 %}
        {% for faq in produit.faqs %}
        <div class="product-faq-item">
          <button class="product-faq-question">{{ faq.question }}</button>
          <div class="product-faq-answer">{{ faq.answer }}</div>
        </div>
        {% endfor %}
      {% else %}
        <div class="product-faq-item">
          <button class="product-faq-question">Est-ce que √ßa fonctionne sur mobile ?</button>
          <div class="product-faq-answer">Oui, le mod√®le est accessible et modifiable sur mobile via Google Sheets.</div>
        </div>
        <div class="product-faq-item">
          <button class="product-faq-question">Puis-je l‚Äôutiliser sans compte Google ?</button>
          <div class="product-faq-answer">Oui, vous pouvez aussi l‚Äôutiliser en version Excel (fichier .xlsx) sur votre ordinateur.</div>
        </div>
        <div class="product-faq-item">
          <button class="product-faq-question">Puis-je l‚Äôoffrir √† quelqu‚Äôun ?</button>
          <div class="product-faq-answer">Absolument. Vous pouvez offrir le fichier et le guide d‚Äôutilisation √† la personne de votre choix.</div>
        </div>
      {% endif %}
    </div>
  </section>

  <!-- 7) GARANTIE / R√âASSURANCE (dynamique) -->
  <section class="product-guarantee">
    <div class="guarantee-items">
      {% if produit.guarantees and produit.guarantees|length > 0 %}
        {% for g in produit.guarantees %}
          {% set txt = (g.text if g is mapping and g.get('text') else (g if g is string else g)) %}
          <div class="guarantee-item">{{ txt }}</div>
        {% endfor %}
      {% else %}
        <div class="guarantee-item">üîÅ Satisfait ou rembours√© sous 7 jours</div>
        <div class="guarantee-item">üîê Paiement 100% s√©curis√© via Mobile Money ou Carte</div>
      {% endif %}
    </div>
  </section>

  <!-- 8) CTA FINAL (dynamique) -->
  <section class="product-final-cta">
    <h3>{{ produit.final_cta_title or "Pr√™t √† prendre le contr√¥le de vos finances ?" }}</h3>
    <button class="btn btn-buy" data-name="{{ produit.name }}" data-price="{{ produit.price }}">
      {{ produit.final_cta_label or "T√©l√©charger maintenant" }}
    </button>
  </section>

  <!-- Description longue -->
  {% if produit.description %}
  <div class="product-description">
    <h2>Description</h2>
    <div class="description-content">
      {{ produit.description|safe }}
    </div>
  </div>
  {% endif %}

  <!-- Carrousel "D√©couvrez aussi" (conserv√©) -->
  <div class="discover-carousel-container mt-5">
    <h4 class="discover-title mb-4">D√©couvrez aussi&nbsp;:</h4>
    <div class="discover-carousel" id="discoverCarousel">
      {% for p in produits|shuffle if p.id != produit.id %}
        <div class="carousel-item">
          <a href="{{ url_for('product_detail', slug=p.slug) }}" class="product-card">
            <div class="product-badges-container">
              {% if p.old_price and p.old_price > p.price %}
                  {% set discount = ((p.old_price - p.price) / p.old_price * 100) | round | int %}
                  <span class="product-badge badge-promo">{{ discount }}% OFF</span>
              {% endif %}
              {% for badge in p.badges %}
                  <span class="product-badge badge-{{ badge.type|lower }}">{{ badge.text }}</span>
              {% endfor %}
            </div>
            <img src="{{ p.images[0].url if p.images else url_for('static', filename='img/logo.webp') }}" alt="{{ p.name }}">
            <div class="product-info">
              <h3>{{ p.name }}</h3>
              <div class="product-desc">{{ (p.short_description or p.description)|striptags|truncate(80) }}</div>
              <div class="product-bottom">
                <span class="product-price">{{ p.price }} XOF</span>
                {% if p.old_price %}<span class="product-old-price">{{ p.old_price }} XOF</span>{% endif %}
              </div>
            </div>
          </a>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Sticky CTA (mobile) -->
  <div class="sticky-cta">
    <button class="btn btn-buy" data-name="{{ produit.name }}" data-price="{{ produit.price }}">
      {{ produit.hero_cta_label or "T√©l√©charger maintenant" }}
    </button>
  </div>

  <!-- Retour -->
  <div class="back-to-products">
    <a href="/produits" class="btn btn-back"> Retour aux produits</a>
  </div>
</section>

<!-- Script notation (conserv√©) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const ratingContainer = document.getElementById('product-rating-interactive');
  if (!ratingContainer) return;

  function getCookie(name) {
    const entry = document.cookie.split('; ').find(row => row.startsWith(name + '='));
    return entry ? decodeURIComponent(entry.split('=')[1]) : null;
  }
  function ensureDeviceId() {
    let id = getCookie('da_device_id');
    if (!id) { try { id = localStorage.getItem('da_device_id') || ''; } catch(e) { id = ''; } }
    if (!id) {
      id = (self.crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString(36) + Math.random().toString(36).slice(2,10));
      const expires = new Date(Date.now() + 730*24*60*60*1000).toUTCString();
      document.cookie = `da_device_id=${encodeURIComponent(id)}; expires=${expires}; path=/; samesite=Lax`;
      try { localStorage.setItem('da_device_id', id); } catch(e) {}
    }
    return id;
  }
  const DEVICE_ID = ensureDeviceId();

  const stars = ratingContainer.querySelectorAll('.star-btn');
  const ratingValueEl = ratingContainer.querySelector('.rating-value');
  const reviewCountEl = ratingContainer.querySelector('.review-count');
  const productId = ratingContainer.dataset.productId;
  let currentAvg = parseFloat(ratingContainer.dataset.initialRating) || 0;

  function updateStars(rating) {
    stars.forEach(star => {
      const val = parseInt(star.dataset.value);
      star.classList.toggle('filled', val <= rating);
    });
  }
  updateStars(Math.round(currentAvg));

  stars.forEach(star => {
    star.addEventListener('mouseover', () => updateStars(parseInt(star.dataset.value)));
    star.addEventListener('mouseout', () => updateStars(Math.round(currentAvg)));
    star.addEventListener('click', () => {
      const newRating = parseInt(star.dataset.value);
      fetch(`/api/produit/${productId}/rate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-DA-Device': DEVICE_ID },
        body: JSON.stringify({ rating: newRating, device_id: DEVICE_ID })
      })
      .then(r => r.json())
      .then(data => {
        if (data.average_rating !== undefined) {
          currentAvg = data.average_rating;
          ratingValueEl.textContent = `${data.average_rating.toFixed(1)}/5`;
          reviewCountEl.textContent = data.reviews_count > 0 ? `‚Äì ${data.reviews_count} avis` : '';
          updateStars(Math.round(currentAvg));
          showNotification(data.action === 'updated' ? 'Votre note a √©t√© mise √† jour.' : 'Merci pour votre vote !', 'success');
        } else {
          showNotification(data.error || 'Erreur lors de la notation.', 'error');
        }
      })
      .catch(() => showNotification('Erreur r√©seau. Veuillez r√©essayer.', 'error'));
    });
  });
});
</script>
{% endblock %}
