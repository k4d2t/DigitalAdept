{% extends "base.html" %}
{% block title %}{{ produit.name }} - Digital Adept{% endblock %}
{% block content %}

<section class="product-page">
  <!-- Panier (inchangé) -->
  <div id="cart-bar" class="hidden">
    <div id="cart-header">
      <h3>Votre panier</h3>
      <button id="close-cart">✘</button>
    </div>
    <div id="cart-items"></div>
    <div id="cart-footer">
      <p>Total : <span id="cart-total" data-price="0" data-currency="XOF">0</span></p>
      <button id="buy-from-cart">Acheter maintenant</button>
    </div>
  </div>

  <!-- 1) HERO (centré, sans visuel ici) -->
  <section class="product-hero">
    <div class="hero-content">
      <h1 class="hero-title">{{ produit.hero_title or produit.name }}</h1>
      <p class="hero-subtitle">
        {{ produit.hero_subtitle or produit.short_description or "Un planificateur simple, visuel et puissant pour gérer votre budget mensuel et annuel" }}
      </p>
      <!-- Petites infos sous le titre -->
      <div class="product-mini-infos">
        {% if produit.stock is not none %}
          {% if produit.stock > 0 %}
            <span class="in-stock">Disponible</span>
          {% else %}
            <span class="out-stock">Indisponible</span>
          {% endif %}
        {% endif %}
        {% if produit.sku %}
          <span class="sku">Réf: {{ produit.sku }}</span>
        {% endif %}
      </div>
    </div>
  </section>

  <!-- 2) PRIX + CTA (centrés, avec note centrée) -->
  <section class="price-cta">
    <div class="product-price-detailed">
      {% if produit.old_price %}
        <span class="old-price" data-price="{{ produit.old_price }}" data-currency="{{ produit.currency }}">{{ produit.old_price }} {{ produit.currency }}</span>
      {% endif %}
      <span class="current-price" data-price="{{ produit.price }}" data-currency="{{ produit.currency }}">{{ produit.price }} {{ produit.currency }}</span>
      {% if produit.old_price and produit.old_price > produit.price %}
        {% set discount = ((produit.old_price - produit.price) / produit.old_price * 100) | round | int %}
        <span class="badge badge-promo" style="margin-left:.6em;">-{{ discount }}%</span>
      {% endif %}
    </div>

    <!-- Notation interactive (unique ID) -->
    <div id="product-rating-interactive" class="product-rating"
         data-product-id="{{ produit.id }}"
         data-initial-rating="{{ rating|default(0) }}"
         data-initial-reviews="{{ reviews_count|default(0) }}">
      <div class="stars-interactive">
        {% for i in range(1, 6) %}
          <button class="star-btn" type="button" data-value="{{ i }}" aria-label="Noter {{ i }} sur 5">
            <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
          </button>
        {% endfor %}
      </div>
      <div class="rating-summary">
        <span class="rating-value">
          {% if reviews_count > 0 %}{{ "%.1f"|format(rating) }}/5{% else %}(Non noté){% endif %}
        </span>
        <span class="review-count">{% if reviews_count > 0 %}– {{ reviews_count }} avis{% endif %}</span>
      </div>
    </div>

    <div class="product-buttons">
      <button class="btn btn-buy"
              data-name="{{ produit.name }}"
              data-price="{{ produit.price }}">
        {{ produit.hero_cta_label or "Télécharger maintenant" }}
      </button>
      <button class="btn btn-cart add-to-cart"
              data-id="{{ produit.id }}"
              data-name="{{ produit.name }}"
              data-price="{{ produit.price }}">
        Ajouter au panier
      </button>
      <button class="btn btn-share" id="share-btn">Partager</button>
    </div>
  </section>

  <!-- 3) CARROUSEL IMAGES PRODUIT (plus grand, centré, responsive) -->
  {% if produit.images and produit.images|length > 0 %}
  <section class="product-carousel">
    <div class="product-gallery">
      <div class="gallery-main">
        <div class="gallery-images">
          {% for img in produit.images %}
            {% set url = (img if img is string else img.url) %}
            {% set base = url.split('/')[-1].rsplit('.', 1)[0] %}
            <picture>
              <source
                srcset="
                  https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/{{ base }}-400.webp 400w,
                  https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/{{ base }}-800.webp 800w,
                  https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/{{ base }}-1200.webp 1200w
                " type="image/webp"
                sizes="(max-width:600px) 100vw, (max-width:1100px) 80vw, 980px">
              <source
                srcset="
                  https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/{{ base }}-400.jpg 400w,
                  https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/{{ base }}-800.jpg 800w,
                  https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/{{ base }}-1200.jpg 1200w
                " type="image/jpeg"
                sizes="(max-width:600px) 100vw, (max-width:1100px) 80vw, 980px">
              <img src="https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/{{ base }}-800.jpg"
                   alt="{{ produit.name }}"
                   class="gallery-img{% if loop.first %} active{% endif %}"
                   width="980" height="560" loading="lazy">
            </picture>
          {% endfor %}
        </div>
        {% if produit.images|length > 1 %}
          <button class="gallery-arrow left" aria-label="Image précédente">&#8249;</button>
          <button class="gallery-arrow right" aria-label="Image suivante">&#8250;</button>
        {% endif %}
      </div>

      {% if produit.images|length > 1 %}
      <div class="gallery-thumbnails">
        {% for img in produit.images %}
          {% set url = (img if img is string else img.url) %}
          {% set base = url.split('/')[-1].rsplit('.', 1)[0] %}
          <picture>
            <source srcset="https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/{{ base }}-400.webp" type="image/webp">
            <source srcset="https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/{{ base }}-400.jpg" type="image/jpeg">
            <img src="https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/{{ base }}-400.jpg"
                 alt="Miniature {{ loop.index }}"
                 class="gallery-thumb{% if loop.first %} active{% endif %}"
                 width="100" height="70" loading="lazy">
          </picture>
        {% endfor %}
      </div>
      {% endif %}
      <div class="gallery-zoom-hint">Survolez ou touchez pour zoomer</div>
    </div>
  </section>
  {% endif %}

  <!-- 4) PROMO (scaring) -->
  {% if produit.old_price and produit.old_price > produit.price %}
  <section class="promo-scare">
    <div class="promo-badge">Promo limitée</div>
    <p>Profitez de <b>{{ ((produit.old_price - produit.price) / produit.old_price * 100) | round | int }}% de réduction</b> aujourd’hui.</p>
    {% if produit.stock is not none and produit.stock > 0 %}
      <p>Plus que <b>{{ produit.stock }}</b> exemplaire(s) au tarif promo.</p>
    {% endif %}
  </section>
  {% endif %}

  <!-- 5) MÉTHODES DE PAIEMENT -->
  <section class="payments-section" aria-label="Méthodes de paiement acceptées">
    <img
      src="{{ url_for('static', filename='img/payments.png') }}"
      alt="Paiements acceptés: Mobile Money, Cartes, etc."
      class="payments-strip"
      loading="lazy"
      width="980" height="200">
  </section>

  <!-- 6) PRIX + CTA -->
  <section class="price-cta">
    <div class="product-price-detailed">
      {% if produit.old_price %}
        <span class="old-price" data-price="{{ produit.old_price }}" data-currency="{{ produit.currency }}">{{ produit.old_price }} {{ produit.currency }}</span>
      {% endif %}
      <span class="current-price" data-price="{{ produit.price }}" data-currency="{{ produit.currency }}">{{ produit.price }} {{ produit.currency }}</span>
    </div>
    <div class="product-buttons">
      <button class="btn btn-buy" data-name="{{ produit.name }}" data-price="{{ produit.price }}">
        {{ produit.hero_cta_label or "Télécharger maintenant" }}
      </button>
      <button class="btn btn-cart add-to-cart"
              data-id="{{ produit.id }}"
              data-name="{{ produit.name }}"
              data-price="{{ produit.price }}">
        Ajouter au panier
      </button>
    </div>
  </section>

  <!-- 7) AVIS CLIENTS -->
  {% set testimonials = comments|selectattr('comment')|list %}
  {% if testimonials and testimonials|length > 0 %}
  <section class="product-testimonials">
    <h2>Avis clients</h2>
    <div class="testimonials-grid">
      {% for c in testimonials[:3] %}
      <div class="testimonial-card">
        <div class="testimonial-header">
          {% if c.photo %}
            <img src="{{ c.photo }}" class="avatar" alt="Avatar client" loading="lazy" width="38" height="38" style="border-radius:50%;object-fit:cover;">
          {% else %}
            <div class="avatar">{{ (c.comment[:1] or 'U')|upper }}</div>
          {% endif %}
          <div class="meta">
            <div class="name">{{ c.name or "Client" }}</div>
            <div class="note">⭐ {{ c.rating or 5 }}/5</div>
          </div>
        </div>
        <p class="content">{{ c.comment }}</p>
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <!-- 8) PRIX + CTA -->
  <section class="price-cta">
    <div class="product-price-detailed">
      {% if produit.old_price %}
        <span class="old-price" data-price="{{ produit.old_price }}" data-currency="{{ produit.currency }}">{{ produit.old_price }} {{ produit.currency }}</span>
      {% endif %}
      <span class="current-price" data-price="{{ produit.price }}" data-currency="{{ produit.currency }}">{{ produit.price }} {{ produit.currency }}</span>
    </div>
    <div class="product-buttons">
      <button class="btn btn-buy" data-name="{{ produit.name }}" data-price="{{ produit.price }}">
        {{ produit.final_cta_label or "Télécharger maintenant" }}
      </button>
      <button class="btn btn-cart add-to-cart"
              data-id="{{ produit.id }}"
              data-name="{{ produit.name }}"
              data-price="{{ produit.price }}">
        Ajouter au panier
      </button>
    </div>
  </section>

  <!-- 9) DESCRIPTION LONGUE (amélioration de rendu) -->
  {% if produit.description %}
  <section class="product-description">
    <h2>Description détaillée</h2>
    <div class="description-content">
      {{ produit.description|safe }}
    </div>
  </section>
  {% endif %}

  <!-- 10) PRIX + CTA -->
  <section class="price-cta">
    <div class="product-price-detailed">
      {% if produit.old_price %}
        <span class="old-price" data-price="{{ produit.old_price }}" data-currency="{{ produit.currency }}">{{ produit.old_price }} {{ produit.currency }}</span>
      {% endif %}
      <span class="current-price" data-price="{{ produit.price }}" data-currency="{{ produit.currency }}">{{ produit.price }} {{ produit.currency }}</span>
    </div>
    <div class="product-buttons">
      <button class="btn btn-buy" data-name="{{ produit.name }}" data-price="{{ produit.price }}">
        {{ produit.final_cta_label or "Télécharger maintenant" }}
      </button>
      <button class="btn btn-cart add-to-cart"
              data-id="{{ produit.id }}"
              data-name="{{ produit.name }}"
              data-price="{{ produit.price }}">
        Ajouter au panier
      </button>
    </div>
  </section>

  <!-- 11) FAQ -->
  <section class="product-faq">
    <h2>Questions fréquentes</h2>
    <div class="product-faq-container">
      {% if produit.faqs and produit.faqs|length > 0 %}
        {% for faq in produit.faqs %}
        <div class="product-faq-item">
          <button class="product-faq-question">{{ faq.question }}</button>
          <div class="product-faq-answer">{{ faq.answer }}</div>
        </div>
        {% endfor %}
      {% else %}
        <div class="product-faq-item">
          <button class="product-faq-question">Est-ce que ça fonctionne sur mobile ?</button>
          <div class="product-faq-answer">Oui, le modèle est accessible et modifiable sur mobile via Google Sheets.</div>
        </div>
        <div class="product-faq-item">
          <button class="product-faq-question">Puis-je l’utiliser sans compte Google ?</button>
          <div class="product-faq-answer">Oui, vous pouvez aussi l’utiliser en version Excel (fichier .xlsx) sur votre ordinateur.</div>
        </div>
        <div class="product-faq-item">
          <button class="product-faq-question">Puis-je l’offrir à quelqu’un ?</button>
          <div class="product-faq-answer">Absolument. Vous pouvez offrir le fichier et le guide d’utilisation à la personne de votre choix.</div>
        </div>
      {% endif %}
    </div>
  </section>

  <!-- 12) PRIX + CTA -->
  <section class="price-cta">
    <div class="product-price-detailed">
      {% if produit.old_price %}
        <span class="old-price" data-price="{{ produit.old_price }}" data-currency="{{ produit.currency }}">{{ produit.old_price }} {{ produit.currency }}</span>
      {% endif %}
      <span class="current-price" data-price="{{ produit.price }}" data-currency="{{ produit.currency }}">{{ produit.price }} {{ produit.currency }}</span>
    </div>
    <div class="product-buttons">
      <button class="btn btn-buy" data-name="{{ produit.name }}" data-price="{{ produit.price }}">
        {{ produit.final_cta_label or "Télécharger maintenant" }}
      </button>
      <button class="btn btn-cart add-to-cart"
              data-id="{{ produit.id }}"
              data-name="{{ produit.name }}"
              data-price="{{ produit.price }}">
        Ajouter au panier
      </button>
    </div>
  </section>

  <!-- 13) PRODUITS SIMILAIRES -->
  <div class="discover-carousel-container mt-5">
    <h4 class="discover-title mb-4">Découvrez aussi&nbsp;:</h4>
    <div class="discover-carousel" id="discoverCarousel">
      {% for p in produits|shuffle if p.id != produit.id %}
        <div class="carousel-item">
          <a href="{{ url_for('product_detail', slug=p.slug) }}" class="product-card">
            <div class="product-badges-container">
              {% if p.old_price and p.old_price > p.price %}
                  {% set discount = ((p.old_price - p.price) / p.old_price * 100) | round | int %}
                  <span class="product-badge badge-promo">{{ discount }}% OFF</span>
              {% endif %}
              {% for badge in p.badges %}
                  <span class="product-badge badge-{{ badge.type|lower }}">{{ badge.text }}</span>
              {% endfor %}
            </div>
            <img src="{{ p.images[0].url if p.images else url_for('static', filename='img/logo.webp') }}" alt="{{ p.name }}">
            <div class="product-info">
              <h3>{{ p.name }}</h3>
              <div class="product-desc">{{ (p.short_description or p.description)|striptags|truncate(80) }}</div>
              <div class="product-bottom">
                <span class="product-price">{{ p.price }} XOF</span>
                {% if p.old_price %}<span class="product-old-price">{{ p.old_price }} XOF</span>{% endif %}
              </div>
            </div>
          </a>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Sticky CTA (mobile) -->
  <div class="sticky-cta">
    <button class="btn btn-buy" data-name="{{ produit.name }}" data-price="{{ produit.price }}">
      {{ produit.hero_cta_label or "Télécharger maintenant" }}
    </button>
  </div>

  <!-- Retour -->
  <div class="back-to-products">
    <a href="/produits" class="btn btn-back">Retour aux produits</a>
  </div>
</section>

<!-- Script notation (inchangé) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const ratingContainer = document.getElementById('product-rating-interactive');
  if (!ratingContainer) return;

  function getCookie(name) {
    const entry = document.cookie.split('; ').find(row => row.startsWith(name + '='));
    return entry ? decodeURIComponent(entry.split('=')[1]) : null;
  }
  function ensureDeviceId() {
    let id = getCookie('da_device_id');
    if (!id) { try { id = localStorage.getItem('da_device_id') || ''; } catch(e) { id = ''; } }
    if (!id) {
      id = (self.crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString(36) + Math.random().toString(36).slice(2,10));
      const expires = new Date(Date.now() + 730*24*60*60*1000).toUTCString();
      document.cookie = `da_device_id=${encodeURIComponent(id)}; expires=${expires}; path=/; samesite=Lax`;
      try { localStorage.setItem('da_device_id', id); } catch(e) {}
    }
    return id;
  }
  const DEVICE_ID = ensureDeviceId();

  const stars = ratingContainer.querySelectorAll('.star-btn');
  const ratingValueEl = ratingContainer.querySelector('.rating-value');
  const reviewCountEl = ratingContainer.querySelector('.review-count');
  let currentAvg = parseFloat(ratingContainer.dataset.initialRating) || 0;

  function updateStars(rating) {
    stars.forEach(star => {
      const val = parseInt(star.dataset.value);
      star.classList.toggle('filled', val <= rating);
    });
  }
  updateStars(Math.round(currentAvg));

  stars.forEach(star => {
    star.addEventListener('mouseover', () => updateStars(parseInt(star.dataset.value)));
    star.addEventListener('mouseout', () => updateStars(Math.round(currentAvg)));
    star.addEventListener('click', () => {
      const newRating = parseInt(star.dataset.value);
      fetch(`/api/produit/{{ produit.id }}/rate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-DA-Device': DEVICE_ID },
        body: JSON.stringify({ rating: newRating, device_id: DEVICE_ID })
      })
      .then(r => r.json())
      .then(data => {
        if (data.average_rating !== undefined) {
          currentAvg = data.average_rating;
          ratingValueEl.textContent = `${data.average_rating.toFixed(1)}/5`;
          reviewCountEl.textContent = data.reviews_count > 0 ? `– ${data.reviews_count} avis` : '';
          updateStars(Math.round(currentAvg));
          showNotification(data.action === 'updated' ? 'Votre note a été mise à jour.' : 'Merci pour votre vote !', 'success');
        } else {
          showNotification(data.error || 'Erreur lors de la notation.', 'error');
        }
      })
      .catch(() => showNotification('Erreur réseau. Veuillez réessayer.', 'error'));
    });
  });
});
</script>
{% endblock %}
