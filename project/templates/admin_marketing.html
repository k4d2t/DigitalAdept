{% extends "admin_base.html" %}
{% block admin_title %}Marketing{% endblock %}

{% block admin_content %}
<div class="dashboard">
    <h1>Marketing - Paniers Abandonnés</h1>
    <nav class="admin-nav">
        <a href="{{ url_for('admin_dashboard') }}">Retour au dashboard</a>
    </nav>
    
    <div class="actions" style="justify-content: flex-start; margin-top: 2em; margin-bottom: 1em;">
        <button id="remindAllBtn" class="cta">Lancer les relances automatiques</button>
    </div>
    
    <div id="relaunch-summary" style="margin-top: 1em; font-weight: bold; min-height: 20px;"></div>

    {% if carts %}
    <table class="marketing-table-responsive">
        <thead>
            <tr>
                <th>Date</th>
                <th>Client</th>
                <th>Email / WhatsApp</th>
                <th>Total</th>
                <th>Relances</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for cart in carts %}
            <tr id="cart-row-{{ cart.id }}">
                <td data-label="Date">{{ cart.created_at.strftime('%d-%m-%Y %H:%M') }}</td>
                <td data-label="Client">{{ cart.customer_name or 'N/A' }}</td>
                <td data-label="Contact">
                    {{ cart.email }}<br>
                    <small>{{ cart.whatsapp_number or 'Pas de numéro' }}</small>
                </td>
                <td data-label="Total">{{ cart.total_price }} XOF</td>
                <td data-label="Relances">
                    {{ cart.relaunch_count }} envoyé(s)<br>
                    <small>Dernière: {{ cart.last_relaunch_at.strftime('%d/%m %Hh%M') if cart.last_relaunch_at else 'Jamais' }}</small>
                </td>
                <td data-label="Actions">
                    <button class="cta remind-btn" data-id="{{ cart.id }}">Forcer 1 relance</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; margin-top: 2em;">Aucun panier abandonné pour le moment.</p>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // Relance individuelle (manuelle)
    document.querySelectorAll('.remind-btn').forEach(button => {
        button.addEventListener('click', () => {
            const cartId = button.dataset.id;
            button.disabled = true;
            button.textContent = 'Envoi...';

            fetch(`/api/marketing/remind/${cartId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    showNotification(data.message, data.status === 'success' ? 'success' : 'error');
                    if (data.status === 'success') {
                        // Optionnel : recharger pour voir les stats à jour
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        button.disabled = false;
                        button.textContent = 'Forcer 1 relance';
                    }
                })
                .catch(() => {
                    showNotification('Erreur réseau.', 'error');
                    button.disabled = false;
                    button.textContent = 'Forcer 1 relance';
                });
        });
    });

    // Relance de masse (automatisée)
    const remindAllBtn = document.getElementById('remindAllBtn');
    
    if (remindAllBtn) {
        remindAllBtn.addEventListener('click', () => {
            ConfirmModal(
                "Lancer la séquence de relances pour tous les paniers éligibles ? Le système respectera les limites et intervalles que vous avez configurés.",
                "Oui, lancer",
                "Annuler",
                () => {
                    remindAllBtn.disabled = true;
                    remindAllBtn.textContent = 'Vérification...';

                    fetch('/api/marketing/remind/all', { method: 'POST' })
                        .then(res => res.json())
                        .then(data => {
                            showNotification(data.message, (data.status === 'success' || data.status === 'info') ? 'success' : 'error');
                            if (data.status === 'success') {
                                setTimeout(() => window.location.reload(), 2000);
                            }
                        })
                        .catch(() => showNotification('Erreur réseau.', 'error'))
                        .finally(() => {
                            remindAllBtn.disabled = false;
                            remindAllBtn.textContent = 'Lancer les relances automatiques';
                        });
                }
            );
        });
    }
});
</script>
{% endblock %}
