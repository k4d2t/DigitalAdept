{% extends "admin_base.html" %}

{% block title %}Marketing - Relance Paniers{% endblock %}

{% block admin_content %}
<div class="admin-page-container" style="padding: 2rem;">
    <h1 style="text-align: center; color: var(--primary-dark);">Marketing - Paniers Abandonnés</h1>
    <p style="text-align: center; color: var(--text); max-width: 700px; margin: 0 auto 2rem auto;">
        Cette section liste tous les paniers qui n'ont pas abouti à un achat. Vous pouvez déclencher manuellement une relance par e-mail pour un client spécifique.
    </p>

    <!-- CORRECTION : Ajout du bouton "Vider la liste" -->
    <div class="actions" style="margin-bottom: 2rem; display: flex; justify-content: center; flex-wrap: wrap; gap: 1rem;">
        <button id="remindAllBtn" class="cta">Relancer tous les paniers</button>
        <a href="{{ url_for('admin_relaunch_settings') }}" class="cta">Paramètres de relance</a>
        <button id="clearAllCartsBtn" class="cta cta-danger">Vider la liste</button>
    </div>

    <div style="overflow-x: auto; width: 100%; max-width: 1200px; margin: 0 auto;">
        <table class="marketing-table-responsive">
            <thead>
                <tr>
                    <th>Client</th>
                    <th>Contact</th>
                    <th>Contenu du Panier</th>
                    <th>Total</th>
                    <th>Statut</th>
                    <th>Date</th>
                    <th>Relances</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for cart in carts %}
                <tr>
                    <td data-label="Client">{{ cart.customer_name or 'N/A' }}</td>
                    <td data-label="Contact" class="contact-cell">
                        <div class="contact-actions">
                            <a href="mailto:{{ cart.email }}" class="contact-btn email-btn" title="Envoyer un e-mail à {{ cart.email }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                            </a>
                            {% if cart.whatsapp_number %}
                                <a href="https://wa.me/{{ cart.whatsapp_number|replace('+', '') }}" target="_blank" class="contact-btn whatsapp-btn" title="Contacter sur WhatsApp">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M16.6 14.2c.2.1.3.2.4.3.1.1.1.3.1.4 0 .1-.03.3-.1.4-.1.1-.2.2-.3.3-.2.1-.4.2-.6.2-.2 0-.4 0-.6-.1-1.4-.5-2.8-1.4-4-2.6-1.2-1.2-2.1-2.6-2.6-4-.1-.2-.1-.4-.1-.6 0-.2 0-.4.1-.6.1-.2.2-.3.3-.4.1-.1.3-.2.4-.3.1-.1.3-.1.4-.1h.1c.2 0 .4.04.6.1.5.2 1 .4 1.4.7.4.3.7.6 1 .9.3.3.5.7.7 1 .2.3.3.7.3 1.1 0 .4-.1.8-.3 1.1-.2.3-.5.6-.8.8-.3.2-.6.4-.8.5-.2.1-.4.2-.5.3-.1.1-.2.2-.2.3v.1c0 .2.03.4.1.5.2.3.4.6.7.8.3.2.6.4.8.6.5.4 1 .8 1.6 1.1.6.3 1.2.5 1.8.6.2.03.4.04.6.04.2 0 .4-.02.6-.05.5-.2 1-.4 1.4-.7.4-.3.8-.6 1.1-.9.3-.3.6-.7.8-1.1.2-.4.3-.8.3-1.2 0-.2-.02-.5-.1-.7zM20 4.2C17.8 2.1 15.1 1 12 1 5.9 1 1 5.9 1 12c0 2.1.6 4.1 1.6 5.9L1 23l5.3-1.4c1.8 1 3.8 1.6 5.8 1.6h.1c6.1 0 11-4.9 11-11 0-3-1.2-5.8-3.2-7.8z"/></svg>
                                </a>
                            {% endif %}
                        </div>
                    </td>
                    <td data-label="Contenu">
                        <ul>
                            {% for item in cart.cart_content %}
                                <li>{{ item.name }} ({{ item.price }} XOF)</li>
                            {% endfor %}
                        </ul>
                    </td>
                    <td data-label="Total">{{ cart.total_price }} XOF</td>
                    <td data-label="Statut">{{ cart.status }}</td>
                    <td data-label="Date">{{ cart.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td data-label="Relances">{{ cart.relaunch_count }}</td>
                    <td data-label="Actions">
                        <button class="remind-btn" data-cart-id="{{ cart.id }}">Relancer</button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" style="text-align: center;">Aucun panier abandonné pour le moment.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- GESTION DU BOUTON VIDER LA LISTE ---
    const clearAllBtn = document.getElementById('clearAllCartsBtn');
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', () => {
            ConfirmModal(
                "Êtes-vous sûr de vouloir supprimer DÉFINITIVEMENT tous les paniers abandonnés ? Cette action est irréversible.",
                "Oui, vider",
                "Annuler",
                () => { // onYes
                    fetch('/api/marketing/clear-all', { method: 'POST' })
                        .then(res => res.json())
                        .then(data => {
                            showNotification(data.message, data.status);
                            if (data.status === 'success') {
                                // Rafraîchit la page pour voir la liste vide
                                setTimeout(() => window.location.reload(), 1500);
                            }
                        })
                        .catch(() => showNotification('Erreur réseau.', 'error'));
                }
            );
        });
    }

    // Le reste du script (relance, etc.) reste inchangé
    document.querySelectorAll('.remind-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const cartId = e.target.getAttribute('data-cart-id');
            e.target.disabled = true;
            e.target.textContent = 'Envoi...';

            fetch(`/api/marketing/remind/${cartId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        showNotification(data.message, 'success');
                        e.target.textContent = 'Relancé';
                    } else {
                        showNotification(data.message, 'error');
                        e.target.textContent = 'Échec';
                        e.target.disabled = false;
                    }
                });
        });
    });

    const remindAllBtn = document.getElementById('remindAllBtn');
    if (remindAllBtn) {
        remindAllBtn.addEventListener('click', () => {
            remindAllBtn.disabled = true;
            remindAllBtn.textContent = 'Lancement...';

            fetch('/api/marketing/remind/all', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    showNotification(data.message, data.status === 'success' ? 'success' : 'info');
                    remindAllBtn.textContent = 'Relancer tous les paniers';
                    remindAllBtn.disabled = false;
                });
        });
    }
});
</script>
{% endblock %}
