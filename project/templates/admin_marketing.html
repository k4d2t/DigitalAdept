{% extends "admin_base.html" %}

{% block title %}Marketing - Relance Paniers{% endblock %}

{% block admin_content %}
<div class="admin-page-container" style="padding: 2rem;">
    <h1 style="text-align: center; color: var(--primary-dark);">Marketing - Paniers Abandonnés</h1>
    <p style="text-align: center; color: var(--text); max-width: 700px; margin: 0 auto 2rem auto;">
        Cette section liste tous les paniers qui n'ont pas abouti à un achat. Vous pouvez déclencher manuellement une relance par e-mail pour un client spécifique.
    </p>

    <div class="actions" style="margin-bottom: 2rem;">
        <button id="remindAllBtn" class="cta">Relancer tous les paniers éligibles</button>
        <a href="{{ url_for('admin_relaunch_settings') }}" class="cta">Paramètres de relance</a>
    </div>

    <div style="overflow-x: auto; width: 100%; max-width: 1200px; margin: 0 auto;">
        <table class="marketing-table-responsive">
            <thead>
                <tr>
                    <th>Client</th>
                    <th>Contact</th>
                    <th>Contenu du Panier</th>
                    <th>Total</th>
                    <th>Statut</th>
                    <th>Date</th>
                    <th>Relances</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for cart in carts %}
                <tr>
                    <td data-label="Client">{{ cart.customer_name or 'N/A' }}</td>
                    
                    <td data-label="Contact" class="contact-cell">
                        <div class="contact-actions">
                            <a href="mailto:{{ cart.email }}" class="contact-btn email-btn" title="Envoyer un e-mail à {{ cart.email }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                            </a>
                            <button class="contact-btn copy-btn" data-copy-value="{{ cart.email }}" title="Copier l'e-mail">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            </button>
                            {% if cart.whatsapp_number %}
                                <a href="https://wa.me/{{ cart.whatsapp_number|replace('+', '') }}" target="_blank" class="contact-btn whatsapp-btn" title="Contacter sur WhatsApp">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                                </a>
                            {% endif %}
                        </div>
                        <span class="copy-feedback">Copié!</span>
                    </td>
                    
                    <td data-label="Contenu">
                        <ul>
                            {% for item in cart.cart_content %}
                                <li>{{ item.name }} ({{ item.price }} XOF)</li>
                            {% endfor %}
                        </ul>
                    </td>
                    <td data-label="Total">{{ cart.total_price }} XOF</td>
                    <td data-label="Statut">{{ cart.status }}</td>
                    <td data-label="Date">{{ cart.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td data-label="Relances">{{ cart.relaunch_count }}</td>
                    <td data-label="Actions">
                        <button class="btn btn-secondary remind-btn" data-cart-id="{{ cart.id }}">Relancer</button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" style="text-align: center;">Aucun panier abandonné pour le moment.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- GESTION DES BOUTONS DE CONTACT ---
    document.querySelectorAll('.copy-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const valueToCopy = e.currentTarget.getAttribute('data-copy-value');
            navigator.clipboard.writeText(valueToCopy).then(() => {
                const feedback = e.currentTarget.closest('.contact-cell').querySelector('.copy-feedback');
                feedback.classList.add('visible');
                // L'animation CSS gère la disparition
            }).catch(err => {
                console.error('Erreur de copie:', err);
                // On n'affiche plus de notification globale d'erreur pour éviter la confusion
            });
        });
    });

    // Le reste du script (relance individuelle et de masse) reste inchangé
    document.querySelectorAll('.remind-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const cartId = e.target.getAttribute('data-cart-id');
            e.target.disabled = true;
            e.target.textContent = 'Envoi...';

            fetch(`/api/marketing/remind/${cartId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        showNotification(data.message, 'success');
                        e.target.textContent = 'Relancé';
                    } else {
                        showNotification(data.message, 'error');
                        e.target.textContent = 'Échec';
                    }
                });
        });
    });

    const remindAllBtn = document.getElementById('remindAllBtn');
    if (remindAllBtn) {
        remindAllBtn.addEventListener('click', () => {
            remindAllBtn.disabled = true;
            remindAllBtn.textContent = 'Lancement des relances...';

            fetch('/api/marketing/remind/all', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    showNotification(data.message, data.status === 'success' ? 'success' : 'info');
                    remindAllBtn.textContent = 'Relancer tous les paniers éligibles';
                    remindAllBtn.disabled = false;
                });
        });
    }
});
</script>
{% endblock %}
