{% extends "admin_base.html" %}

{% block title %}Marketing - Relance Paniers{% endblock %}

{% block admin_content %}
<div class="admin-page-container" style="padding: 2rem;">
    <h1 style="text-align: center; color: var(--primary-dark);">Marketing - Paniers Abandonnés</h1>
    <p style="text-align: center; color: var(--text); max-width: 700px; margin: 0 auto 2rem auto;">
        Cette section liste tous les paniers qui n'ont pas abouti à un achat. Vous pouvez déclencher manuellement une relance par e-mail pour un client spécifique.
    </p>

    <div class="actions" style="margin-bottom: 2rem;">
        <button id="remindAllBtn" class="cta">Relancer tous les paniers éligibles</button>
        <a href="{{ url_for('admin_relaunch_settings') }}" class="cta">Paramètres de relance</a>
    </div>

    <div style="overflow-x: auto; width: 100%; max-width: 1200px; margin: 0 auto;">
        <table class="marketing-table-responsive">
            <thead>
                <tr>
                    <th>Client</th>
                    <th>Contact</th>
                    <th>Contenu du Panier</th>
                    <th>Total</th>
                    <th>Statut</th>
                    <th>Date</th>
                    <th>Relances</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for cart in carts %}
                <tr>
                    <td data-label="Client">{{ cart.customer_name or 'N/A' }}</td>
                    
                    <!-- CORRECTION : Suppression du bouton copier, uniquement Mail et WhatsApp -->
                    <td data-label="Contact" class="contact-cell">
                        <div class="contact-actions">
                            <!-- Bouton pour envoyer un e-mail -->
                            <a href="mailto:{{ cart.email }}" class="contact-btn email-btn" title="Envoyer un e-mail à {{ cart.email }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                            </a>
                            <!-- Bouton WhatsApp (si le numéro existe) -->
                            {% if cart.whatsapp_number %}
                                <a href="https://wa.me/{{ cart.whatsapp_number|replace('+', '') }}" target="_blank" class="contact-btn whatsapp-btn" title="Contacter sur WhatsApp">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M16.75 13.96c.25.13.41.2.52.34.12.14.16.3.16.46 0 .17-.04.33-.12.48s-.2.28-.35.39-.33.2-.52.28c-.19.07-.38.12-.57.14a2.9 2.9 0 0 1-1.5-.27c-.52-.2-1.02-.5-1.5-.88-.48-.38-.93-.8-1.34-1.26-.41-.46-.78-.97-1.1-1.52-.32-.55-.54-1.12-.67-1.7-.12-.58-.1-1.14.03-1.68.13-.54.38-1.04.74-1.48.36-.44.83-.79 1.4-1.04a2.9 2.9 0 0 1 1.63-.37c.3.02.6.1.88.22.28.13.54.28.78.47.24.19.46.4.64.64.18.24.33.5.44.76.11.26.18.52.2.78a2.55 2.55 0 0 1-.16 1.28c-.13.4-.33.77-.6 1.1-.26.33-.58.6-.96.82a1.1 1.1 0 0 1-1.1-.1c-.1-.08-.18-.18-.24-.28-.06-.1-.1-.2-.12-.32a1.2 1.2 0 0 1 .1-1.02c.1-.2.25-.38.44-.52.19-.14.4-.26.63-.34.23-.08.47-.12.7-.12a1.2 1.2 0 0 1 1.1.42c.2.2.35.45.44.7.1.24.13.5.1.75-.03.25-.12.5-.26.73-.14.23-.33.43-.56.6-.23.16-.5.28-.78.36a1.6 1.6 0 0 1-1.02.04c-.3-.07-.58-.2-.84-.36-.26-.16-.5-.35-.7-.57-.2-.22-.38-.46-.52-.72-.14-.26-.25-.53-.32-.82-.07-.29-.1-.58-.08-.88a2.55 2.55 0 0 1 .4-1.4c.2-.4.48-.75.8-1.04.33-.29.7-.5 1.1-.63.4-.13.8-.18 1.2-.14.4.04.8.16 1.15.34.35.18.66.42.92.7.26.28.48.6.63.95.16.35.25.72.27 1.1zM19.8 4.2C17.6 2 15 1 12 1 5.9 1 1 5.9 1 12c0 2.1.6 4.1 1.6 5.9L1 23l5.3-1.4c1.8 1 3.8 1.6 5.8 1.6h.1c6.1 0 11-4.9 11-11 0-3-1.2-5.8-3.2-7.8z"/></svg>
                                </a>
                            {% endif %}
                        </div>
                    </td>
                    
                    <td data-label="Contenu">
                        <ul>
                            {% for item in cart.cart_content %}
                                <li>{{ item.name }} ({{ item.price }} XOF)</li>
                            {% endfor %}
                        </ul>
                    </td>
                    <td data-label="Total">{{ cart.total_price }} XOF</td>
                    <td data-label="Statut">{{ cart.status }}</td>
                    <td data-label="Date">{{ cart.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td data-label="Relances">{{ cart.relaunch_count }}</td>
                    <td data-label="Actions">
                        <button class="remind-btn" data-cart-id="{{ cart.id }}">Relancer</button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" style="text-align: center;">Aucun panier abandonné pour le moment.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Le script est maintenant plus simple, il n'y a plus de bouton "copier" à gérer.

    // Relance individuelle
    document.querySelectorAll('.remind-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const cartId = e.target.getAttribute('data-cart-id');
            e.target.disabled = true;
            e.target.textContent = 'Envoi...';

            fetch(`/api/marketing/remind/${cartId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        showNotification(data.message, 'success');
                        e.target.textContent = 'Relancé';
                    } else {
                        showNotification(data.message, 'error');
                        e.target.textContent = 'Échec';
                        e.target.disabled = false; // Réactiver le bouton en cas d'échec
                    }
                })
                .catch(() => {
                    showNotification('Erreur réseau.', 'error');
                    e.target.textContent = 'Relancer';
                    e.target.disabled = false;
                });
        });
    });

    // Relance de masse
    const remindAllBtn = document.getElementById('remindAllBtn');
    if (remindAllBtn) {
        remindAllBtn.addEventListener('click', () => {
            remindAllBtn.disabled = true;
            remindAllBtn.textContent = 'Lancement des relances...';

            fetch('/api/marketing/remind/all', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    showNotification(data.message, data.status === 'success' ? 'success' : 'info');
                    remindAllBtn.textContent = 'Relancer tous les paniers éligibles';
                    remindAllBtn.disabled = false;
                })
                .catch(() => {
                    showNotification('Erreur lors de la relance de masse.', 'error');
                    remindAllBtn.textContent = 'Relancer tous les paniers éligibles';
                    remindAllBtn.disabled = false;
                });
        });
    }
});
</script>
{% endblock %}
