{% extends "admin_base.html" %}

{% block admin_title %}
    Gestion des Produits
{% endblock %}

{% block admin_content %}
<div class="products-manage -h1">
    <h1>Gestion des Produits</h1>
    <nav class="admin-nav">
        <a href="{{ url_for('admin_products_page') }}">Retour</a>
    </nav>
    <div class="admin-toolbar glassy-toolbar" style="margin-bottom:1.2em;display:flex;justify-content:center;">
      <input type="search" id="adminProductSearch" class="admin-search-bar"
             placeholder="Rechercher un produit..." style="max-width:350px;">
    </div>
    <style>
        .admin-toolbar.glassy-toolbar {
            background: var(--toolbar-bg,rgba(34,34,50,0.36));
            box-shadow: 0 2px 12px var(--toolbar-border,rgba(58,138,255,0.13)), var(--neon);
            border-radius: 1.5em;
            padding: 0.6em 1.3em;
            margin: 0 auto 1.2em auto;
            backdrop-filter: blur(8px);
            border: 1.2px solid var(--toolbar-border,rgba(58,138,255,0.13));
        }

        .admin-search-bar {
            width: 100%;
            font-family: var(--toolbar-font, 'Google Sans', 'Roboto', Arial, sans-serif);
            font-size: 1em;
            padding: 0.7em 1.2em;
            border-radius: 1.8em;
            border: none;
            background: transparent;
            color: #fff;
            box-shadow: 0 0 0 1.3px var(--accent-strong,#6ec0ff), 0 0 8px var(--accent-strong,#6ec0ff)33;
            outline: none;
            transition: box-shadow 0.2s, background 0.2s;
            backdrop-filter: blur(3.5px);
            margin: 0 0.7em;
        }
        .admin-search-bar::placeholder {
            color: #cdd7ff;
            opacity: 0.6;
        }
        .admin-search-bar:focus {
            box-shadow: 0 0 0 2px var(--accent,#3a8aff), 0 0 12px var(--accent,#3a8aff)55, var(--neon);
            background: rgba(80, 180, 255, 0.04);
        }

         .admin-pagination-bar {
            display: flex;
            gap: 0.6em;
            justify-content: center;
            margin-top: 1.5em;
            flex-wrap: wrap;
        }
        .admin-pagination-btn {
            background: var(--primary-dark, #1976d2);
            color: #fff;
            border-radius: 50%;
            border: none;
            width: 2.1em;
            height: 2.1em;
            font-weight: bold;
            font-size: 1em;
            margin: 0 0.18em;
            transition: background 0.18s, color 0.18s;
            box-shadow: var(--neon);
            cursor: pointer;
        }
        .admin-pagination-btn.active,
        .admin-pagination-btn:hover {
            background: var(--primary, #4fc3f7);
            color: #222;
            box-shadow: var(--neon-hover);
        }

    </style>
    <div class="products-grid" id="productsGrid">
        <!-- Les cartes des produits seront générées ici par JavaScript -->
    </div>
    <div id="adminPagination" class="admin-pagination-bar" style="display:flex;justify-content:center;margin-top:1.5em;gap:0.6em;"></div>
</div>

<div id="productEditModal" class="custom-modal">
    <div class="custom-modal-content">
        <span class="custom-modal-close" onclick="closeProductModal()">&times;</span>
        <h2>Modifier le Produit</h2>
        <form id="productEditForm" class="product-form" enctype="multipart/form-data">
            <!-- Nom -->
            <label for="productName">Nom du Produit :</label>
            <input type="text" id="productName" name="name" required>

            <!-- Description courte -->
            <label for="productShortDescription">Description Courte :</label>
            <input type="text" id="productShortDescription" name="short_description">

            <!-- Description enrichie -->
            <label for="productDescription">Description :</label>
            <div id="productDescriptionEditor"></div>

            <!-- Prix & Ancien Prix -->
            <div class="form-row">
                <div class="form-group">
                    <label for="productPrice">Prix :</label>
                    <input type="number" id="productPrice" name="price" required>
                </div>
                <div class="form-group">
                    <label for="productOldPrice">Ancien Prix :</label>
                    <input type="number" id="productOldPrice" name="old_price">
                </div>
            </div>

            <!-- Devise & Stock -->
            <div class="form-row">
                <div class="form-group">
                    <label for="productCurrency">Devise :</label>
                    <select id="productCurrency" name="currency" required>
                        <option value="XOF">XOF (Franc CFA)</option>
                        <option value="USD">USD (Dollar)</option>
                        <option value="EUR">EUR (Euro)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="productStock">Stock :</label>
                    <input type="number" id="productStock" name="stock" required>
                </div>
            </div>
            
            <!-- SKU & Catégorie -->
            <div class="form-row">
                <div class="form-group">
                    <label for="productSku">SKU :</label>
                    <input type="text" id="productSku" name="sku">
                </div>
                <div class="form-group">
                    <label for="productCategory">Catégorie :</label>
                    <input type="text" id="productCategory" name="category" required>
                </div>
            </div>

            <!-- Fichiers de ressource (multi) -->
            <label>Resource File IDs (Telegram) :</label>
            <div id="resourceFileIdsContainerEdit"></div>
            <button type="button" id="addResourceFileIdBtnEdit" class="add-row-btn">+ Ajouter un File ID</button>

            <!-- Images -->
            <label>Images :</label>
            <div id="productImagesContainer" class="images-preview-container"></div>
            <div class="custom-file-upload-container">
                <input type="file" id="productImages" name="images[]" multiple accept="image/*" class="file-input-hidden">
                <button type="button" id="customFileUploadButton">Ajouter des Images</button>
                <span id="fileUploadStatus"></span>
            </div>

            <!-- Gestion des badges -->
            <label>Badges (le badge "Promo" est auto si un ancien prix est défini) :</label>
            <div id="productBadgesContainer"></div>
            <button type="button" id="addBadgeButton" class="add-row-btn">+ Ajouter un Badge</button>

            <!-- FAQ -->
            <label>FAQ :</label>
            <div id="productFaqContainer"></div>
            <button type="button" id="addFaqButton" class="add-row-btn">+ Ajouter une Q/R</button>

            <!-- Produit en vedette -->
            <div class="form-group-checkbox">
                <input type="checkbox" id="productFeatured" name="featured">
                <label for="productFeatured">Mettre ce produit en vedette</label>
            </div>

            <!-- Bouton Enregistrer -->
            <button type="submit" class="submit-btn">Enregistrer les Modifications</button>
        </form>
    </div>
</div>
<style>
    /* Centrage et alignement des tuiles produits */
    .products-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: flex-start;
    gap: 2em 2em;
    margin: 0 auto;
    width: 100%;
    padding-bottom: 2em;
    min-height: 200px;
    box-sizing: border-box;
    }
    .product-card {
    margin: 0;
    flex: 0 1 320px;
    cursor: pointer;
    border: 1px solid transparent;
    padding: 1em;
    border-radius: 12px;
    transition: all 0.2s ease-in-out;
    }
    .product-card:hover {
        border-color: var(--primary);
        transform: translateY(-3px);
        box-shadow: 0 4px 15px #0000001a;
    }
    .products-manage {
    max-width: 1200px;
    margin: 0 auto;
    }
    /* CORRECTION : Style pour la modale pour éviter les scrollbars */
    .custom-modal-content {
        width: 90%;
        max-width: 800px; /* Limite la largeur maximale */
    }

</style>
<script>
// CORRECTION : Déclaration de la fonction pour fermer la modale dans la portée globale
function closeProductModal() {
    const modal = document.getElementById("productEditModal");
    if (modal) {
        modal.style.display = "none";
    }
}

document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("productEditForm");
    const imageInput = document.getElementById("productImages");
    const customFileUploadButton = document.getElementById("customFileUploadButton");
    const fileUploadStatus = document.getElementById("fileUploadStatus");
    const imagesContainer = document.getElementById("productImagesContainer");
    const badgesContainer = document.getElementById("productBadgesContainer");
    const faqContainer = document.getElementById("productFaqContainer");
    let imagesField = [];
    let selectedEditFilesSet = new Set();
    let quill;

    let allProducts = [];
    let currentPage = 1;
    const itemsPerPage = 6;

    initializeRichTextEditor();

    form.setAttribute("enctype", "multipart/form-data");
    form.addEventListener("submit", (e) => {
        e.preventDefault();
        updateProduct();
    });

    customFileUploadButton.addEventListener("click", () => imageInput.click());
    imageInput.addEventListener("change", handleFileSelection);

    document.getElementById("addBadgeButton").addEventListener("click", () => addBadge());
    document.getElementById("addFaqButton").addEventListener("click", () => addFaq());
    
    document.getElementById('adminProductSearch').addEventListener('input', function(){
        currentPage = 1;
        renderProducts();
    });

    function renderPagination(totalItems) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const paginationContainer = document.getElementById('adminPagination');
        paginationContainer.innerHTML = '';
        if (totalPages <= 1) return;

        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.className = 'admin-pagination-btn' + (i === currentPage ? ' active' : '');
            btn.onclick = () => {
                currentPage = i;
                renderProducts();
            };
            paginationContainer.appendChild(btn);
        }
    }

    function renderProducts() {
        const grid = document.getElementById("productsGrid");
        grid.innerHTML = "";
        
        const searchTerm = document.getElementById('adminProductSearch').value.trim().toLowerCase();
        const filteredProducts = allProducts.filter(p => p.name.toLowerCase().includes(searchTerm));
        const paginatedProducts = filteredProducts.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

        if (paginatedProducts.length === 0) {
            grid.innerHTML = "<p>Aucun produit ne correspond à votre recherche.</p>";
        } else {
            paginatedProducts.forEach((product) => {
                const card = document.createElement("div");
                card.className = "product-card";
                card.setAttribute("data-id", product.id);
                
                const imageUrl = product.images.length > 0 ? product.images[0] : 'https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/default.jpg';
                card.innerHTML = `
                    ${renderProductPicture(imageUrl, product.name)}
                    <h2>${product.name}</h2>
                    <p><strong>Prix :</strong> ${product.price} ${product.currency}</p>
                    <p><strong>Stock :</strong> ${product.stock}</p>
                    <div class="product-card-actions">
                        <button class="delete-button" title="Supprimer">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                        </button>
                    </div>
                `;
                card.addEventListener("click", (e) => {
                    if (!e.target.closest('.delete-button')) {
                        openProductModal(product.id);
                    }
                });
                card.querySelector(".delete-button").addEventListener("click", (event) => {
                    event.stopPropagation();
                    ConfirmModal(`Supprimer "${product.name}" ?`, "Oui, supprimer", "Non", () => deleteProduct(product.id));
                });
                grid.appendChild(card);
            });
        }
        renderPagination(filteredProducts.length);
    }
    
    function loadProducts() {
        fetch("/admin/products")
            .then((response) => response.json())
            .then((products) => {
                allProducts = products.sort((a, b) => b.id - a.id);
                currentPage = 1;
                renderProducts();
            })
            .catch((error) => console.error("Erreur lors du chargement des produits :", error));
    }

    function deleteProduct(productId) {
        fetch(`/admin/products/manage/${productId}`, { method: "DELETE" })
            .then((response) => {
                if (response.ok) {
                    showNotification("Produit supprimé avec succès !", "success");
                    loadProducts();
                } else {
                    showNotification("Erreur lors de la suppression du produit.", "error");
                }
            })
            .catch((error) => console.error("Erreur lors de la suppression du produit :", error));
    }

    function openProductModal(productId) {
        fetch(`/admin/products/manage/${productId}`)
            .then((response) => response.json())
            .then((product) => {
                form.setAttribute("data-product-id", productId);
                document.getElementById("productName").value = product.name;
                document.getElementById("productShortDescription").value = product.short_description || "";
                quill.root.innerHTML = product.description;
                document.getElementById("productPrice").value = product.price;
                document.getElementById("productOldPrice").value = product.old_price || "";
                document.getElementById("productCurrency").value = product.currency;
                document.getElementById("productStock").value = product.stock;
                document.getElementById("productSku").value = product.sku || "";
                document.getElementById("productCategory").value = product.category;
                document.getElementById("productFeatured").checked = !!product.featured;
                
                let fileIds = product.resource_files ? product.resource_files.map(rf => rf.file_id) : [];
                renderResourceFileIdInputs(fileIds);

                badgesContainer.innerHTML = "";
                if(product.badges) product.badges.forEach((badge) => addBadge(badge));

                faqContainer.innerHTML = "";
                if(product.faq) product.faq.forEach((faq) => addFaq(faq));

                imagesContainer.innerHTML = "";
                imagesField = [...product.images];
                imagesField.forEach((imageUrl) => displayExistingImage(imageUrl));

                document.getElementById("productEditModal").style.display = "block";
                selectedEditFilesSet.clear();
                fileUploadStatus.textContent = "";
            })
            .catch((error) => console.error("Erreur lors de l'ouverture de la modale :", error));
    }

    function handleFileSelection(event) {
        const files = event.target.files;
        if (files.length > 0) {
            Array.from(files).forEach((file) => {
                if (!selectedEditFilesSet.has(file.name)) {
                    displayImagePreview(file);
                    selectedEditFilesSet.add(file.name);
                }
            });
            fileUploadStatus.textContent = `${selectedEditFilesSet.size} nouveau(x) fichier(s) prêt(s)`;
        }
    }

    function displayImagePreview(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const imageWrapper = document.createElement("div");
            imageWrapper.className = "image-wrapper";
            imageWrapper.innerHTML = `<img src="${e.target.result}" class="preview-image"><span class="remove-image">&times;</span>`;
            imageWrapper.querySelector(".remove-image").addEventListener("click", () => {
                selectedEditFilesSet.delete(file.name);
                imageWrapper.remove();
                fileUploadStatus.textContent = selectedEditFilesSet.size ? `${selectedEditFilesSet.size} nouveau(x) fichier(s) prêt(s)` : "";
            });
            imagesContainer.appendChild(imageWrapper);
        };
        reader.readAsDataURL(file);
    }
    
    function addBadge(badge = { type: 'info', text: '' }) {
        const badgeDiv = document.createElement("div");
        badgeDiv.className = "dynamic-form-row";
        badgeDiv.innerHTML = `
            <select class="badge-type-select">
                <option value="nouveau" ${badge.type === 'nouveau' ? 'selected' : ''}>Nouveau</option>
                <option value="populaire" ${badge.type === 'populaire' ? 'selected' : ''}>Populaire</option>
                <option value="exclusif" ${badge.type === 'exclusif' ? 'selected' : ''}>Exclusif</option>
                <option value="info" ${badge.type === 'info' ? 'selected' : ''}>Info</option>
            </select>
            <input type="text" class="badge-text-input" value="${badge.text || ''}" placeholder="Texte du badge">
            <button type="button" class="remove-row-btn" onclick="this.parentElement.remove()">–</button>
        `;
        badgesContainer.appendChild(badgeDiv);
    }

    function addFaq(faq = { question: '', answer: '' }) {
        const faqDiv = document.createElement("div");
        faqDiv.className = "dynamic-form-row";
        faqDiv.innerHTML = `
            <input type="text" class="faq-question-input" value="${faq.question || ''}" placeholder="Question">
            <textarea class="faq-answer-input" placeholder="Réponse">${faq.answer || ''}</textarea>
            <button type="button" class="remove-row-btn" onclick="this.parentElement.remove()">–</button>
        `;
        faqContainer.appendChild(faqDiv);
    }

    const resourceFileIdsContainerEdit = document.getElementById("resourceFileIdsContainerEdit");
    const addResourceFileIdBtnEdit = document.getElementById("addResourceFileIdBtnEdit");

    function renderResourceFileIdInputs(fileIds = []) {
        resourceFileIdsContainerEdit.innerHTML = "";
        if (fileIds.length === 0) fileIds = [""];
        fileIds.forEach((fileId) => {
            const row = document.createElement("div");
            row.className = "dynamic-form-row";
            row.innerHTML = `
                <input type="text" name="resource_file_id[]" value="${fileId || ""}" placeholder="ID du fichier Telegram">
                <button type="button" class="remove-row-btn" onclick="this.parentElement.remove()">–</button>
            `;
            resourceFileIdsContainerEdit.appendChild(row);
        });
    }

    addResourceFileIdBtnEdit.addEventListener("click", () => {
        const row = document.createElement("div");
        row.className = "dynamic-form-row";
        row.innerHTML = `<input type="text" name="resource_file_id[]" placeholder="ID du fichier Telegram"><button type="button" class="remove-row-btn" onclick="this.parentElement.remove()">–</button>`;
        resourceFileIdsContainerEdit.appendChild(row);
    });

    function renderProductPicture(url, alt = "Image produit") {
        return `<picture style="display:block; text-align:center; margin-bottom: 1em;"><img src="${url}" alt="${alt}" style="max-width:100%; height:120px; object-fit:cover; border-radius:8px; box-shadow:0 2px 8px #0003;" loading="lazy"></picture>`;
    }

    function displayExistingImage(imageUrl) {
        const imageWrapper = document.createElement("div");
        imageWrapper.className = "image-wrapper";
        imageWrapper.style.position = 'relative';
        imageWrapper.innerHTML = `
            ${renderProductPicture(imageUrl, "Image existante")}
            <span class="remove-image" style="position:absolute; top:4px; right:4px; cursor:pointer; background: #0008; color: #fff; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;">&times;</span>
        `;
        imageWrapper.querySelector(".remove-image").addEventListener("click", function(event) {
            event.stopPropagation();
            ConfirmModal("Supprimer cette image définitivement ?", "Oui", "Non", () => {
                fetch(`/admin/products/manage/${form.getAttribute("data-product-id")}/image/delete`, {
                    method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ imageUrl }),
                })
                .then((res) => res.json())
                .then((result) => {
                    if (result.message) {
                        showNotification("Image supprimée avec succès.", "success");
                        imageWrapper.remove();
                    } else {
                        showNotification("Erreur lors de la suppression de l'image.", "error");
                    }
                });
            });
        });
        imagesContainer.appendChild(imageWrapper);
    }

    function updateProduct() {
        const productId = form.getAttribute("data-product-id");
        const formData = new FormData();
        
        formData.append("name", document.getElementById("productName").value);
        formData.append("short_description", document.getElementById("productShortDescription").value);
        formData.append("description", quill.root.innerHTML);
        formData.append("price", document.getElementById("productPrice").value);
        formData.append("old_price", document.getElementById("productOldPrice").value);
        formData.append("currency", document.getElementById("productCurrency").value);
        formData.append("stock", document.getElementById("productStock").value);
        formData.append("sku", document.getElementById("productSku").value);
        formData.append("category", document.getElementById("productCategory").value);
        formData.append("featured", document.getElementById("productFeatured").checked);

        const badges = Array.from(badgesContainer.children).map(div => ({ 
            type: div.querySelector(".badge-type-select").value, 
            text: div.querySelector(".badge-text-input").value 
        }));
        formData.append("badges", JSON.stringify(badges));

        const faqs = Array.from(faqContainer.children).map(div => ({ 
            question: div.querySelector(".faq-question-input").value, 
            answer: div.querySelector(".faq-answer-input").value 
        }));
        formData.append("faq", JSON.stringify(faqs));

        const resource_files = Array.from(resourceFileIdsContainerEdit.querySelectorAll("input[name='resource_file_id[]']")).map(input => input.value.trim()).filter(val => val !== "");
        formData.append("resource_file_id", JSON.stringify(resource_files));

        Array.from(imageInput.files).forEach(file => formData.append("images", file));

        fetch(`/admin/products/manage/${productId}`, { method: "PUT", body: formData })
            .then((response) => response.json())
            .then((data) => {
                 if(data.message) {
                    showNotification("Produit mis à jour avec succès !", "success");
                    closeProductModal();
                    loadProducts();
                 } else {
                    showNotification(data.error || "Erreur lors de la mise à jour.", "error");
                 }
            })
            .catch((error) => {
                showNotification("Erreur lors de la mise à jour du produit.", "error");
                console.error(error);
            });
    }

    function initializeRichTextEditor() {
        if(quill) return;
        quill = new Quill("#productDescriptionEditor", {
            theme: "snow",
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline', 'strike'],
                    [{ 'align': [] }], [{ 'color': [] }, { 'background': [] }],
                    [{ 'script': 'sub'}, { 'script': 'super' }], ['blockquote', 'code-block'],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }, { 'indent': '-1'}, { 'indent': '+1' }],
                    ['link', 'image', 'video', 'formula'], ['clean'], [{ 'table': [] }]
                ],
                table: true, clipboard: { matchVisual: false }, history: { delay: 2000, maxStack: 500, userOnly: true }
            }
        });
    }
    
    // Lancement initial
    loadProducts();
});
</script>
{% endblock %}
