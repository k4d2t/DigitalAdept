{% extends "admin_base.html" %}

{% block admin_title %}
    Gestion des Produits
{% endblock %}

{% block admin_content %}
<div class="products-manage -h1">
    <h1>Gestion des Produits</h1>
    <nav class="admin-nav">
        <a href="{{ url_for('admin_products_page') }}">Retour</a>
    </nav>
    <div class="admin-toolbar glassy-toolbar">
      <input type="search" id="adminProductSearch" class="admin-search-bar"
             placeholder="Rechercher un produit par nom...">
    </div>
    
    <div class="products-grid" id="productsGrid">
        <!-- Les cartes des produits seront générées ici par JavaScript -->
    </div>
    <div id="adminPagination" class="admin-pagination-bar"></div>
</div>

<!-- MODALE D'ÉDITION -->
<div id="productEditModal" class="custom-modal">
    <div class="custom-modal-content">
        <span class="custom-modal-close" onclick="closeProductModal()">&times;</span>
        <h2>Modifier le Produit</h2>
        <form id="productEditForm" enctype="multipart/form-data">
            <!-- Nom -->
            <label for="productNameEdit">Nom du Produit :</label>
            <input type="text" id="productNameEdit" name="name" required>

            <!-- Description courte -->
            <label for="productShortDescriptionEdit">Description Courte :</label>
            <input type="text" id="productShortDescriptionEdit" name="short_description">

            <!-- Description enrichie -->
            <label for="productDescriptionEditorEdit">Description :</label>
            <div id="productDescriptionEditorEdit"></div>

            <!-- Prix & Ancien Prix -->
            <div class="form-row">
                <div class="form-group">
                    <label for="productPriceEdit">Prix :</label>
                    <input type="number" id="productPriceEdit" name="price" required>
                </div>
                <div class="form-group">
                    <label for="productOldPriceEdit">Ancien Prix :</label>
                    <input type="number" id="productOldPriceEdit" name="old_price">
                </div>
            </div>

            <!-- Devise & Stock -->
            <div class="form-row">
                <div class="form-group">
                    <label for="productCurrencyEdit">Devise :</label>
                    <select id="productCurrencyEdit" name="currency" required>
                        <option value="XOF">XOF (Franc CFA)</option>
                        <option value="USD">USD (Dollar)</option>
                        <option value="EUR">EUR (Euro)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="productStockEdit">Stock :</label>
                    <input type="number" id="productStockEdit" name="stock" required>
                </div>
            </div>
            
            <!-- SKU & Catégorie -->
            <div class="form-row">
                <div class="form-group">
                    <label for="productSkuEdit">SKU :</label>
                    <input type="text" id="productSkuEdit" name="sku">
                </div>
                <div class="form-group">
                    <label for="productCategoryEdit">Catégorie :</label>
                    <input type="text" id="productCategoryEdit" name="category" required>
                </div>
            </div>

            <!-- Fichiers de ressource (multi) -->
            <label>Resource File IDs (Telegram) :</label>
            <div id="resourceFileIdsContainerEdit"></div>
            <button type="button" id="addResourceFileIdBtnEdit" class="add-row-btn">+ Ajouter un File ID</button>

            <!-- Images -->
            <label>Images :</label>
            <div id="productImagesContainerEdit" class="images-preview-container"></div>
            <div class="custom-file-upload-container">
                <input type="file" id="productImagesEdit" name="images" multiple accept="image/*" class="file-input-hidden">
                <button type="button" id="customFileUploadButtonEdit">Ajouter des Images</button>
                <span id="fileUploadStatusEdit"></span>
            </div>

            <!-- Gestion des badges -->
            <label>Badges (le badge "Promo" est automatique si un ancien prix est défini) :</label>
            <div id="productBadgesContainerEdit"></div>
            <button type="button" id="addBadgeButtonEdit" class="add-row-btn">+ Ajouter un Badge</button>

            <!-- FAQ -->
            <label>FAQ :</label>
            <div id="productFaqContainerEdit"></div>
            <button type="button" id="addFaqButtonEdit" class="add-row-btn">+ Ajouter une Q/R</button>

            <!-- Produit en vedette -->
            <div class="form-group-checkbox">
                <input type="checkbox" id="productFeaturedEdit" name="featured">
                <label for="productFeaturedEdit">Mettre ce produit en vedette</label>
            </div>

            <!-- Bouton Enregistrer -->
            <button type="submit" class="submit-btn">Enregistrer les Modifications</button>
        </form>
    </div>
</div>

<style>
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5em;
        padding: 1em;
        min-height: 200px;
    }
    .products-manage { max-width: 1300px; margin: 0 auto; }
    .product-card-admin {
        background: var(--contact-card-bg);
        border: 1px solid var(--contact-border);
        border-radius: 12px;
        padding: 1em;
        display: flex;
        flex-direction: column;
        transition: all .2s;
        cursor: pointer;
    }
    .product-card-admin:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 20px #0000001a;
    }
    .product-card-admin .img-preview { width: 100%; aspect-ratio: 16/10; object-fit: cover; border-radius: 8px; margin-bottom: 1em; background: #eee; }
    .product-card-admin h3 { margin: 0 0 0.5em; font-size: 1.1em; }
    .product-card-admin p { margin: 0.2em 0; font-size: 0.9em; }
    .product-card-admin-actions { margin-top: auto; padding-top: 1em; display:flex; justify-content: flex-end; }
    .product-card-admin-actions .delete-button { background: #e74c3c; color: white; border: none; border-radius: 50%; width: 36px; height: 36px; cursor: pointer; display:flex; align-items:center; justify-content:center; }
    .product-card-admin-actions .delete-button svg { width: 20px; height: 20px; }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("productEditForm");
    const imageInput = document.getElementById("productImagesEdit");
    const customFileUploadButton = document.getElementById("customFileUploadButtonEdit");
    const fileUploadStatus = document.getElementById("fileUploadStatusEdit");
    const imagesContainer = document.getElementById("productImagesContainerEdit");
    const badgesContainer = document.getElementById("productBadgesContainerEdit");
    const faqContainer = document.getElementById("productFaqContainerEdit");
    const resourceFileIdsContainer = document.getElementById("resourceFileIdsContainerEdit");

    let allProducts = [];
    let currentPage = 1;
    const itemsPerPage = 9;
    let quill;

    initializeRichTextEditor();

    form.addEventListener("submit", (e) => e.preventDefault());
    form.querySelector('.submit-btn').addEventListener('click', updateProduct);
    
    customFileUploadButton.addEventListener("click", () => imageInput.click());
    imageInput.addEventListener("change", handleFileSelection);
    document.getElementById("addBadgeButtonEdit").addEventListener("click", () => addBadge());
    document.getElementById("addFaqButtonEdit").addEventListener("click", () => addFaq());
    document.getElementById("addResourceFileIdBtnEdit").addEventListener("click", () => addResourceFileIdInput());

    document.getElementById('adminProductSearch').addEventListener('input', () => {
        currentPage = 1;
        renderProducts();
    });

    function loadAndRender() {
        fetch("/admin/products")
            .then(response => response.json())
            .then(products => {
                allProducts = products.sort((a, b) => b.id - a.id); // Plus récents en premier par ID
                renderProducts();
            })
            .catch(error => console.error("Erreur chargement produits:", error));
    }

    function renderProducts() {
        const searchTerm = document.getElementById('adminProductSearch').value.toLowerCase();
        const filteredProducts = allProducts.filter(p => p.name.toLowerCase().includes(searchTerm));

        const grid = document.getElementById("productsGrid");
        grid.innerHTML = "";

        const paginatedProducts = filteredProducts.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

        paginatedProducts.forEach(product => {
            const card = document.createElement("div");
            card.className = "product-card-admin";
            const imageUrl = product.images.length > 0 ? product.images[0] : 'https://cdn.jsdelivr.net/gh/k4d2t/DigitalAdept@main/project/static/img/default.jpg';
            
            card.innerHTML = `
                <img src="${imageUrl}" class="img-preview" alt="Aperçu de ${product.name}" loading="lazy">
                <h3>${product.name}</h3>
                <p><strong>Prix :</strong> ${product.price} ${product.currency}</p>
                <p><strong>Stock :</strong> ${product.stock}</p>
                <div class="product-card-admin-actions">
                    <button class="delete-button" title="Supprimer">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                    </button>
                </div>
            `;
            card.addEventListener("click", (e) => {
                if (!e.target.closest('.delete-button')) openProductModal(product.id);
            });
            card.querySelector(".delete-button").addEventListener("click", (e) => {
                e.stopPropagation();
                ConfirmModal(`Supprimer "${product.name}" ?`, "Oui, supprimer", "Annuler", () => deleteProduct(product.id));
            });
            grid.appendChild(card);
        });
        renderPagination(filteredProducts.length);
    }

    function renderPagination(totalItems) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const pagination = document.getElementById('adminPagination');
        pagination.innerHTML = '';
        if (totalPages <= 1) return;

        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.className = 'admin-pagination-btn' + (i === currentPage ? ' active' : '');
            btn.onclick = () => { currentPage = i; renderProducts(); };
            pagination.appendChild(btn);
        }
    }

    function deleteProduct(productId) {
        fetch(`/admin/products/manage/${productId}`, { method: "DELETE" })
            .then(res => {
                if (res.ok) {
                    showNotification("Produit supprimé !", "success");
                    loadAndRender();
                } else {
                    res.json().then(data => showNotification(data.error || "Erreur suppression.", "error"));
                }
            });
    }

    function openProductModal(productId) {
        fetch(`/admin/products/manage/${productId}`)
            .then(response => response.json())
            .then(product => {
                form.dataset.productId = product.id;
                document.getElementById("productNameEdit").value = product.name;
                document.getElementById("productShortDescriptionEdit").value = product.short_description || "";
                quill.root.innerHTML = product.description || "";
                document.getElementById("productPriceEdit").value = product.price;
                document.getElementById("productOldPriceEdit").value = product.old_price || "";
                document.getElementById("productCurrencyEdit").value = product.currency;
                document.getElementById("productStockEdit").value = product.stock;
                document.getElementById("productSkuEdit").value = product.sku || "";
                document.getElementById("productCategoryEdit").value = product.category;
                document.getElementById("productFeaturedEdit").checked = !!product.featured;

                renderDynamicInputs(badgesContainer, product.badges || [], addBadge);
                renderDynamicInputs(faqContainer, product.faq || [], addFaq);
                renderDynamicInputs(resourceFileIdsContainer, product.resource_files || [], addResourceFileIdInput);

                imagesContainer.innerHTML = "";
                (product.images || []).forEach(imageUrl => displayExistingImage(imageUrl));
                imageInput.value = "";
                fileUploadStatus.textContent = "";

                document.getElementById("productEditModal").style.display = "block";
            });
    }

    function renderDynamicInputs(container, data, addFn) {
        container.innerHTML = "";
        if (data && data.length > 0) {
            data.forEach(item => addFn(item));
        }
    }

    function addBadge(badge = { type: 'info', text: '' }) {
        const div = document.createElement("div");
        div.className = "dynamic-form-row";
        div.innerHTML = `
            <select class="badge-type-select">
                <option value="nouveau" ${badge.type === 'nouveau' ? 'selected' : ''}>Nouveau</option>
                <option value="populaire" ${badge.type === 'populaire' ? 'selected' : ''}>Populaire</option>
                <option value="exclusif" ${badge.type === 'exclusif' ? 'selected' : ''}>Exclusif</option>
                <option value="info" ${badge.type === 'info' ? 'selected' : ''}>Info</option>
            </select>
            <input type="text" class="badge-text-input" value="${badge.text || ''}" placeholder="Texte du badge">
            <button type="button" class="remove-row-btn" onclick="this.parentElement.remove()">–</button>
        `;
        badgesContainer.appendChild(div);
    }

    function addFaq(faq = { question: '', answer: '' }) {
        const div = document.createElement("div");
        div.className = "dynamic-form-row";
        div.innerHTML = `
            <input type="text" class="faq-question-input" value="${faq.question || ''}" placeholder="Question">
            <textarea class="faq-answer-input" placeholder="Réponse">${faq.answer || ''}</textarea>
            <button type="button" class="remove-row-btn" onclick="this.parentElement.remove()">–</button>
        `;
        faqContainer.appendChild(div);
    }
    
    function addResourceFileIdInput(file = { file_id: '' }) {
        const div = document.createElement("div");
        div.className = "dynamic-form-row";
        div.innerHTML = `
            <input type="text" class="resource-file-id-input" value="${file.file_id || ''}" placeholder="ID du fichier Telegram">
            <button type="button" class="remove-row-btn" onclick="this.parentElement.remove()">–</button>
        `;
        resourceFileIdsContainer.appendChild(div);
    }

    function handleFileSelection(event) {
        fileUploadStatus.textContent = event.target.files.length > 0 ? `${event.target.files.length} nouveau(x) fichier(s) prêt(s)` : "";
    }

    function displayExistingImage(imageUrl) {
        const wrapper = document.createElement("div");
        wrapper.className = "image-wrapper";
        wrapper.innerHTML = `<img src="${imageUrl}" class="preview-image"><span class="remove-image" title="Supprimer">&times;</span>`;
        wrapper.querySelector(".remove-image").addEventListener("click", (e) => {
            e.stopPropagation();
            ConfirmModal("Supprimer cette image définitivement ?", "Oui", "Non", () => {
                fetch(`/admin/products/manage/${form.dataset.productId}/image/delete`, {
                    method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ imageUrl }),
                })
                .then(res => res.json())
                .then(result => {
                    if (result.message) { showNotification("Image supprimée.", "success"); wrapper.remove(); } 
                    else { showNotification(result.error || "Erreur suppression.", "error"); }
                });
            });
        });
        imagesContainer.appendChild(wrapper);
    }
    
    function updateProduct() {
        const productId = form.dataset.productId;
        const formData = new FormData();
        
        formData.append("name", document.getElementById("productNameEdit").value);
        formData.append("short_description", document.getElementById("productShortDescriptionEdit").value);
        formData.append("description", quill.root.innerHTML);
        formData.append("price", document.getElementById("productPriceEdit").value);
        formData.append("old_price", document.getElementById("productOldPriceEdit").value);
        formData.append("currency", document.getElementById("productCurrencyEdit").value);
        formData.append("stock", document.getElementById("productStockEdit").value);
        formData.append("sku", document.getElementById("productSkuEdit").value);
        formData.append("category", document.getElementById("productCategoryEdit").value);
        formData.append("featured", document.getElementById("productFeaturedEdit").checked);

        const badges = Array.from(badgesContainer.children).map(div => ({ type: div.querySelector(".badge-type-select").value, text: div.querySelector(".badge-text-input").value }));
        formData.append("badges", JSON.stringify(badges));

        const faqs = Array.from(faqContainer.children).map(div => ({ question: div.querySelector(".faq-question-input").value, answer: div.querySelector(".faq-answer-input").value }));
        formData.append("faq", JSON.stringify(faqs));

        const resource_files = Array.from(resourceFileIdsContainer.querySelectorAll(".resource-file-id-input")).map(input => ({ file_id: input.value.trim() })).filter(rf => rf.file_id);
        formData.append("resource_file_id", JSON.stringify(resource_files));

        Array.from(imageInput.files).forEach(file => formData.append("images", file));

        fetch(`/admin/products/manage/${productId}`, { method: "PUT", body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.message) {
                    showNotification("Produit mis à jour !", "success");
                    closeProductModal();
                    loadAndRender();
                } else { showNotification(data.error || "Erreur mise à jour.", "error"); }
            });
    }

    window.closeProductModal = function() {
        document.getElementById("productEditModal").style.display = "none";
    }

    function initializeRichTextEditor() {
        if(quill) return;
        quill = new Quill("#productDescriptionEditorEdit", {
            theme: "snow",
            modules: { toolbar: [
                [{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline'],
                [{'list': 'ordered'}, {'list': 'bullet'}], ['link', 'image', 'code-block']
            ]}
        });
    }

    loadAndRender();
});
</script>
{% endblock %}
