{% extends "base.html" %}
{% block content %}
<section class="downloads-page">
  <div class="downloads-header">
    <h1>Vos Téléchargements</h1>
    <p>Accédez facilement aux fichiers de vos produits achetés ou obtenus.</p>
  </div>
  <span class="download-header error-message">
  <br>
  {% if message %}
    {{ message }}
  {% endif %}
  </span>
  <div id="modals-container" class="modals-container">
    <!-- Les modales des produits seront insérées ici dynamiquement -->
  </div>
</section>

<script>
    // ---- Vider le Panier au Chargement de la Page ----
    document.addEventListener("DOMContentLoaded", function () {
        const currentPath = window.location.pathname;
        if (currentPath.startsWith("/download/")) {
            localStorage.removeItem("cart");
            cart = [];
        }
    });

    const products = {{ products | tojson }};
    const botToken = "7734969718:AAGtUifNLlIUadA-jfT0tQKH60iu_Qu2kSQ";

    // Fonction pour générer le lien Telegram
    async function generateTelegramLink(fileId) {
        try {
            const response = await fetch(`https://api.telegram.org/bot${botToken}/getFile?file_id=${fileId}`);
            const data = await response.json();
            if (data.ok) {
                const filePath = data.result.file_path;
                return `https://api.telegram.org/file/bot${botToken}/${filePath}`;
            } else {
                throw new Error("Erreur lors de la récupération du lien. Contactez l'assistance");
            }
        } catch (error) {
            console.error(error);
            showNotification("Impossible de générer le lien. Contactez l'assistance.", "error");
            return null;
        }
    }

    // Création des modales dynamiques pour chaque produit
    document.addEventListener("DOMContentLoaded", async function () {
        const modalsContainer = document.getElementById("modals-container");

        for (const product of products) {
            // 1. On récupère un tableau de file_ids (si string ou undefined, on le convertit en array)
            let fileIds = product.resource_file_id;
            if (!fileIds) fileIds = [];
            if (typeof fileIds === "string") {
                try { fileIds = JSON.parse(fileIds); } catch { fileIds = [fileIds]; }
            }
            if (!Array.isArray(fileIds)) fileIds = [fileIds];

            // 2. Génère tous les liens en parallèle
            const links = await Promise.all(fileIds.map(fid => generateTelegramLink(fid)));

            // 3. Si aucun lien valide, passe au suivant
            if (!links.length || links.every(l => !l)) continue;

            // 4. Crée la modale avec N liens
            const modal = document.createElement("div");
            modal.className = "modal";
            let linksHtml = "";
            links.forEach((link, idx) => {
                if (!link) return;
                linksHtml += `
                    <div class="resource-file-download">
                        <label>Lien ${links.length > 1 ? idx + 1 : ""}</label>
                        <input type="text" class="download-link" value="${link}" readonly />
                        <div class="modal-buttons">
                            <button class="btn btn-primary" onclick="handleDownload('${link}')">Télécharger</button>
                            <button class="btn btn-secondary" onclick="handleCopy('${link}')">Copier le lien</button>
                            <button class="btn btn-tertiary" onclick="window.open('${link}', '_blank')">Ouvrir le lien</button>
                        </div>
                    </div>
                `;
            });

            modal.innerHTML = `
                <div class="modal-content">
                    <h2 class="product-title">${product.name}</h2>
                    <p>Voici vos liens de téléchargement pour ce produit :</p>
                    ${linksHtml}
                </div>
            `;
            modalsContainer.appendChild(modal);
        }
    });

    // Gestion du clic sur le bouton "Télécharger"
    function handleDownload(link) {
        window.location.href = link;
        showNotification("Téléchargement initié !");
    }

    // Gestion du clic sur le bouton "Copier le lien"
    function handleCopy(link) {
        navigator.clipboard.writeText(link).then(() => {
            showNotification("Copié !");
        }).catch(err => {
            console.error(err);
            showNotification("Erreur lors de la copie.", "error");
        });
    }
</script>
{% endblock %}
