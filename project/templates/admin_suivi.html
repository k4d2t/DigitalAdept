{% extends "admin_base.html" %}
{% block admin_title %}Suivi du Chiffre d'Affaires{% endblock %}

{% block admin_content %}
<div class="suivi-page">
    <nav class="admin-nav">
        <a href="{{ url_for('admin_dashboard') }}">← Retour au tableau de bord</a>
    </nav>
    <h1>Suivi du Chiffre d'Affaires</h1>

    <!-- Filtre auto (pas de bouton) -->
    <div class="filter-card">
        <form id="period-filter-form" onsubmit="return false;">
            <div class="filter-controls">
                <select name="period" id="period-select" aria-label="Choisir une période">
                    <option value="today">Aujourd'hui</option>
                    <option value="last_7_days">7 derniers jours</option>
                    <option value="last_30_days">30 derniers jours</option>
                    <option value="this_month" selected>Ce mois-ci</option>
                    <option value="last_month">Mois dernier</option>
                    <option value="custom">Période personnalisée</option>
                </select>

                <div id="custom-date-range" class="custom-date-controls" style="display:none;">
                    <input type="date" name="start_date" id="start_date" aria-label="Date de début">
                    <span>à</span>
                    <input type="date" name="end_date" id="end_date" aria-label="Date de fin">
                </div>
            </div>
        </form>
    </div>

    <!-- KPIs -->
    <div class="suivi-kpis">
        <div class="kpi-card">
            <div class="kpi-title">CA Total (période)</div>
            <div class="kpi-value" id="kpi-total">0 XOF</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">Votre Commission</div>
            <div class="kpi-value" id="kpi-user">0 XOF</div>
            <div class="kpi-detail" id="kpi-detail"></div>
        </div>
    </div>

    <!-- Graphique -->
    <div class="chart-container">
        <h2>Évolution du Chiffre d'Affaires</h2>
        <canvas id="revenueChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const periodSelect = document.getElementById('period-select');
    const customRange = document.getElementById('custom-date-range');
    const startInput = document.getElementById('start_date');
    const endInput = document.getElementById('end_date');

    // Style harmonisé: le select suit le thème via CSS (admin.css)
    // Affichage/masquage des dates personnalisées
    function toggleCustom() {
        customRange.style.display = (periodSelect.value === 'custom') ? 'flex' : 'none';
    }
    periodSelect.addEventListener('change', () => { toggleCustom(); fetchAndUpdate(); });
    startInput.addEventListener('change', fetchAndUpdate);
    endInput.addEventListener('change', fetchAndUpdate);

    const ctx = document.getElementById('revenueChart').getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 320);
    gradient.addColorStop(0, 'rgba(79, 195, 247, 0.6)');
    gradient.addColorStop(1, 'rgba(25, 118, 210, 0.1)');

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: "Chiffre d'Affaires (XOF)",
                data: [],
                backgroundColor: gradient,
                borderColor: '#4FC3F7',
                borderWidth: 3,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#1976D2',
                pointHoverBackgroundColor: '#1976D2',
                pointHoverBorderColor: '#fff',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // géré par CSS
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#E8F1FA' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                    ticks: { color: '#E8F1FA' },
                    grid: { display: false }
                }
            },
            plugins: { legend: { display: false } }
        }
    });

    const fmt = new Intl.NumberFormat('fr-FR');

    async function fetchAndUpdate() {
        const params = new URLSearchParams();
        params.set('period', periodSelect.value);
        if (periodSelect.value === 'custom') {
            if (!startInput.value || !endInput.value) return; // attend les deux dates
            params.set('start_date', startInput.value);
            params.set('end_date', endInput.value);
        }

        try {
            const res = await fetch(`/api/admin/suivi/metrics?${params.toString()}`, { credentials: 'same-origin' });
            if (!res.ok) return;
            const data = await res.json();

            // KPIs
            document.getElementById('kpi-total').textContent = `${fmt.format(Math.round(data.total_revenue))} XOF`;
            document.getElementById('kpi-user').textContent = `${fmt.format(Math.round(data.user_revenue))} XOF`;
            const detail = (data.role && data.role !== 'super_admin') ? `(${data.user_percentage}% du CA)` : '';
            document.getElementById('kpi-detail').textContent = detail;

            // Graph
            chart.data.labels = data.labels || [];
            chart.data.datasets[0].data = (data.data || []).map(v => Math.round(v));
            chart.update();
        } catch (e) {
            console.error('Erreur fetch metrics', e);
        }
    }

    // Initialisation
    toggleCustom();
    fetchAndUpdate();
});
</script>
{% endblock %}
