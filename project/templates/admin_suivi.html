{% extends "admin_base.html" %}
{% block admin_title %}Suivi du Chiffre d'Affaires{% endblock %}

{% block admin_content %}
<div class="suivi-page">
    <nav class="admin-nav">
        <a href="{{ url_for('admin_dashboard') }}">← Retour au tableau de bord</a>
    </nav>
    <h1>Suivi du Chiffre d'Affaires</h1>

    <div class="filter-card">
        <form id="period-filter-form" onsubmit="return false;">
            <div class="filter-controls">
                <select name="period" id="period-select" aria-label="Choisir une période">
                    <option value="today">Aujourd'hui</option>
                    <option value="last_7_days">7 derniers jours</option>
                    <option value="last_30_days">30 derniers jours</option>
                    <option value="this_month" selected>Ce mois-ci</option>
                    <option value="last_month">Mois dernier</option>
                    <option value="custom">Période personnalisée</option>
                </select>

                <div id="custom-date-range" class="custom-date-controls" style="display:none;">
                    <input type="date" name="start_date" id="start_date" aria-label="Date de début">
                    <span>à</span>
                    <input type="date" name="end_date" id="end_date" aria-label="Date de fin">
                </div>
            </div>
        </form>
    </div>

    <div class="suivi-kpis">
        <div class="kpi-card">
            <div class="kpi-title">CA Total (période)</div>
            <div class="kpi-value" id="kpi-total">0 XOF</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">Votre Commission</div>
            <div class="kpi-value" id="kpi-user">0 XOF</div>
            <div class="kpi-detail" id="kpi-detail"></div>
        </div>
    </div>
    <div class="kpi-card" id="kpiAvailableCard" style="display:none;">
      <div class="kpi-title">Solde disponible</div>
      <div class="kpi-value" id="kpiAvailableBalance">--</div>
      <div class="kpi-detail">XOF</div>
    </div>

    <div class="chart-container">
        <h2>Évolution du Chiffre d'Affaires</h2>
        <canvas id="revenueChart"></canvas>
    </div>

    <h1 style="margin-top:1.2rem">Suivi des Visiteurs</h1>
    <div class="suivi-kpis">
        <div class="kpi-card">
            <div class="kpi-title">Pages vues (période)</div>
            <div class="kpi-value" id="kpi-pageviews">0</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">Visiteurs uniques</div>
            <div class="kpi-value" id="kpi-visitors">0</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">Actifs (5 min)</div>
            <div class="kpi-value" id="kpi-active">0</div>
            <div class="kpi-detail">Sessions récentes</div>
        </div>
    </div>

    <div class="chart-container">
        <h2>Trafic (Pages vues vs Visiteurs)</h2>
        <canvas id="visitorsChart"></canvas>
    </div>

    <div class="chart-container">
        <h2>Pages les plus consultées</h2>
        <ul id="topPagesList" class="top-pages"></ul>
    </div>

    <!-- NOUVEAU: Live + Appareils -->
    <div class="chart-container">
        <h2>En temps réel (5 dernières minutes)</h2>
        <ul id="liveVisitorsList" class="top-pages"></ul>
    </div>

    <div class="chart-container">
        <h2>Répartition appareils</h2>
        <div class="device-grid" style="display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
            <div>
                <h3>Par type</h3>
                <ul id="devicesByType" class="top-pages"></ul>
            </div>
            <div>
                <h3>Top marques</h3>
                <ul id="devicesTopBrands" class="top-pages"></ul>
            </div>
            <div>
                <h3>OS</h3>
                <ul id="devicesByOS" class="top-pages"></ul>
            </div>
            <div>
                <h3>Navigateur</h3>
                <ul id="devicesByBrowser" class="top-pages"></ul>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function refreshAvailableBalanceKPI() {
  const card = document.getElementById('kpiAvailableCard');
  const valEl = document.getElementById('kpiAvailableBalance');
  if (!card || !valEl) return;
  try {
    const res = await fetch('/api/payout/balance', { credentials: 'same-origin' });
    if (!res.ok) { card.style.display = 'none'; return; }
    const data = await res.json();
    if (data.status !== 'success' || typeof data.available !== 'number') { card.style.display = 'none'; return; }
    valEl.textContent = Number(data.available).toLocaleString('fr-FR');
    card.style.display = '';
  } catch { card.style.display = 'none'; }
}

document.addEventListener('DOMContentLoaded', () => { refreshAvailableBalanceKPI(); });
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const periodSelect = document.getElementById('period-select');
    const customRange = document.getElementById('custom-date-range');
    const startInput = document.getElementById('start_date');
    const endInput = document.getElementById('end_date');

    function toggleCustom() {
        customRange.style.display = (periodSelect.value === 'custom') ? 'flex' : 'none';
    }
    periodSelect.addEventListener('change', () => { toggleCustom(); fetchRevenue(); fetchVisitors(); fetchTopPages(); fetchDevices(); });
    startInput.addEventListener('change', () => { if (periodSelect.value==='custom') { fetchRevenue(); fetchVisitors(); fetchTopPages(); fetchDevices(); }});
    endInput.addEventListener('change', () => { if (periodSelect.value==='custom') { fetchRevenue(); fetchVisitors(); fetchTopPages(); fetchDevices(); }});

    const ctx = document.getElementById('revenueChart').getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 320);
    gradient.addColorStop(0, 'rgba(79, 195, 247, 0.6)');
    gradient.addColorStop(1, 'rgba(25, 118, 210, 0.1)');

    const revenueChart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{
            label: "Chiffre d'Affaires (XOF)",
            data: [],
            backgroundColor: gradient,
            borderColor: '#4FC3F7',
            borderWidth: 3,
            pointBackgroundColor: '#fff',
            pointBorderColor: '#1976D2',
            pointHoverBackgroundColor: '#1976D2',
            pointHoverBorderColor: '#fff',
            tension: 0.4, fill: true
        }]},
        options: { responsive: true, maintainAspectRatio: false,
            scales: { y:{beginAtZero:true, ticks:{color:'#E8F1FA'}, grid:{color:'rgba(255,255,255,0.1)'}},
                      x:{ticks:{color:'#E8F1FA'}, grid:{display:false}} },
            plugins:{ legend:{ display:false } }
        }
    });

    const fmt = new Intl.NumberFormat('fr-FR');

    async function fetchRevenue() {
        const params = new URLSearchParams();
        params.set('period', periodSelect.value);
        if (periodSelect.value === 'custom') {
            if (!startInput.value || !endInput.value) return;
            params.set('start_date', startInput.value);
            params.set('end_date', endInput.value);
        }
        try {
            const res = await fetch(`/api/admin/suivi/metrics?${params.toString()}`, { credentials: 'same-origin' });
            if (!res.ok) return;
            const data = await res.json();
            document.getElementById('kpi-total').textContent = `${fmt.format(Math.round(data.total_revenue))} XOF`;
            document.getElementById('kpi-user').textContent = `${fmt.format(Math.round(data.user_revenue))} XOF`;
            const detail = (data.role && data.role !== 'super_admin') ? `(${data.user_percentage}% du CA)` : '';
            document.getElementById('kpi-detail').textContent = detail;
            revenueChart.data.labels = data.labels || [];
            revenueChart.data.datasets[0].data = (data.data || []).map(v => Math.round(v));
            revenueChart.update();
        } catch (e) { console.error('Erreur fetch metrics', e); }
    }

    const vctx = document.getElementById('visitorsChart').getContext('2d');
    const visitorsChart = new Chart(vctx, {
        type: 'line',
        data: { labels: [], datasets: [
            { label: "Pages vues", data: [], borderColor:'#FFB74D', backgroundColor:'rgba(255,183,77,0.2)', borderWidth:2, tension:0.35, fill:true },
            { label: "Visiteurs", data: [], borderColor:'#81C784', backgroundColor:'rgba(129,199,132,0.2)', borderWidth:2, tension:0.35, fill:true }
        ]},
        options: { responsive:true, maintainAspectRatio:false,
            scales:{ y:{beginAtZero:true, ticks:{color:'#E8F1FA'}, grid:{color:'rgba(255,255,255,0.08)'}},
                     x:{ticks:{color:'#E8F1FA'}, grid:{display:false}} }
        }
    });

    async function fetchVisitors() {
        const params = new URLSearchParams();
        params.set('period', periodSelect.value);
        if (periodSelect.value === 'custom') {
            if (!startInput.value || !endInput.value) return;
            params.set('start_date', startInput.value);
            params.set('end_date', endInput.value);
        }
        try {
            const res = await fetch(`/api/admin/suivi/visitors/summary?${params.toString()}`, { credentials:'same-origin' });
            if (res.ok) {
                const s = await res.json();
                document.getElementById('kpi-pageviews').textContent = fmt.format(s.pageviews||0);
                document.getElementById('kpi-visitors').textContent = fmt.format(s.visitors||0);
                document.getElementById('kpi-active').textContent = fmt.format(s.active_5m||0);
            }
        } catch(e){}

        try {
            const res2 = await fetch(`/api/admin/suivi/visitors/timeseries?${params.toString()}`, { credentials:'same-origin' });
            if (res2.ok) {
                const t = await res2.json();
                visitorsChart.data.labels = t.labels || [];
                visitorsChart.data.datasets[0].data = (t.pageviews||[]).map(Number);
                visitorsChart.data.datasets[1].data = (t.visitors||[]).map(Number);
                visitorsChart.update();
            }
        } catch(e){}
    }

    async function fetchTopPages() {
        const params = new URLSearchParams();
        params.set('period', periodSelect.value);
        if (periodSelect.value === 'custom') {
            if (!startInput.value || !endInput.value) return;
            params.set('start_date', startInput.value);
            params.set('end_date', endInput.value);
        }
        try {
            const res = await fetch(`/api/admin/suivi/visitors/top-pages?${params.toString()}`, { credentials:'same-origin' });
            const list = document.getElementById('topPagesList');
            list.innerHTML = '';
            if (res.ok) {
                const arr = await res.json();
                arr.forEach(row => {
                    const li = document.createElement('li');
                    li.textContent = `${row.path} — ${fmt.format(row.pageviews)} vues`;
                    list.appendChild(li);
                });
            }
        } catch(e){}
    }

    async function fetchLiveVisitors() {
        try {
            const res = await fetch('/api/admin/suivi/visitors/live', { credentials: 'same-origin', cache: 'no-store' });
            if (!res.ok) return;
            const data = await res.json();
            // KPI actif (rafraîchi en “live” aussi)
            if (typeof data.active_5m === 'number') {
                document.getElementById('kpi-active').textContent = fmt.format(data.active_5m || 0);
            }
            const list = document.getElementById('liveVisitorsList');
            if (!list) return;
            list.innerHTML = '';
            (data.events || []).forEach(ev => {
                const li = document.createElement('li');
                const when = new Date(ev.ts).toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
                const who = [
                    ev.device_type || 'unknown',
                    ev.device_brand || '',
                    ev.device_model || '',
                    ev.os || '',
                    ev.browser || ''
                ].filter(Boolean).join(' • ');
                li.textContent = `[${when}] ${ev.path} — ${who}`;
                list.appendChild(li);
            });
        } catch(e) {}
    }

    async function fetchDevices() {
        const params = new URLSearchParams();
        params.set('period', periodSelect.value);
        if (periodSelect.value === 'custom') {
            if (!startInput.value || !endInput.value) return;
            params.set('start_date', startInput.value);
            params.set('end_date', endInput.value);
        }
        try {
            const res = await fetch(`/api/admin/suivi/visitors/devices?${params.toString()}`, { credentials:'same-origin' });
            if (!res.ok) return;
            const data = await res.json();
            const typeList = document.getElementById('devicesByType');
            const brandList = document.getElementById('devicesTopBrands');
            const osList = document.getElementById('devicesByOS');
            const brList = document.getElementById('devicesByBrowser');
            if (typeList) {
                typeList.innerHTML = '';
                (data.by_type || []).forEach(row => {
                    const li = document.createElement('li');
                    li.textContent = `${row.type} — ${fmt.format(row.count)}`;
                    typeList.appendChild(li);
                });
            }
            if (brandList) {
                brandList.innerHTML = '';
                (data.top_brands || []).forEach(row => {
                    const li = document.createElement('li');
                    li.textContent = `${row.brand} — ${fmt.format(row.count)}`;
                    brandList.appendChild(li);
                });
            }
            if (osList) {
                osList.innerHTML = '';
                (data.by_os || []).forEach(row => {
                    const li = document.createElement('li');
                    li.textContent = `${row.os} — ${fmt.format(row.count)}`;
                    osList.appendChild(li);
                });
            }
            if (brList) {
                brList.innerHTML = '';
                (data.by_browser || []).forEach(row => {
                    const li = document.createElement('li');
                    li.textContent = `${row.browser} — ${fmt.format(row.count)}`;
                    brList.appendChild(li);
                });
            }
        } catch(e) {}
    }

    // Poll “live” toutes les 10 secondes
    setInterval(fetchLiveVisitors, 10000);

    toggleCustom();
    fetchRevenue();
    fetchVisitors();
    fetchTopPages();
    fetchDevices();
    fetchLiveVisitors();
});
</script>
{% endblock %}
