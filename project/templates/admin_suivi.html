{% extends "admin_base.html" %}

{% block admin_title %}Suivi du Chiffre d'Affaires{% endblock %}

{% block admin_content %}
<div class="suivi-page">
    <nav class="admin-nav">
        <a href="{{ url_for('admin_dashboard') }}">← Retour au tableau de bord</a>
    </nav>
    <h1>Suivi du Chiffre d'Affaires</h1>

    <!-- FORMULAIRE DE FILTRE INTÉGRÉ DANS UNE CARTE STYLISÉE -->
    <div class="filter-card">
        <form id="period-filter-form" method="GET" action="{{ url_for('admin_suivi') }}">
            <div class="filter-controls">
                <select name="period" id="period-select">
                    <option value="today" {% if selected_period == 'today' %}selected{% endif %}>Aujourd'hui</option>
                    <option value="last_7_days" {% if selected_period == 'last_7_days' %}selected{% endif %}>7 derniers jours</option>
                    <option value="last_30_days" {% if selected_period == 'last_30_days' %}selected{% endif %}>30 derniers jours</option>
                    <option value="this_month" {% if selected_period == 'this_month' %}selected{% endif %}>Ce mois-ci</option>
                    <option value="last_month" {% if selected_period == 'last_month' %}selected{% endif %}>Mois dernier</option>
                    <option value="custom" {% if selected_period == 'custom' %}selected{% endif %}>Période personnalisée</option>
                </select>

                <div id="custom-date-range" class="custom-date-controls" {% if selected_period != 'custom' %}style="display: none;"{% endif %}>
                    <input type="date" name="start_date" value="{{ start_date }}">
                    <span>à</span>
                    <input type="date" name="end_date" value="{{ end_date }}">
                </div>

                <button type="submit" class="cta-button filter-btn">Appliquer</button>
            </div>
        </form>
    </div>

    <!-- Indicateurs Clés (KPIs) - Inchangé -->
    <div class="suivi-kpis">
        <div class="kpi-card">
            <div class="kpi-title">CA Total (période)</div>
            <div class="kpi-value">{{ "%.0f"|format(total_revenue) }} XOF</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">Votre Commission</div>
            <div class="kpi-value">{{ "%.0f"|format(user_revenue) }} XOF</div>
            {% if role != 'super_admin' %}
                <div class="kpi-detail">({{ user_percentage }}% du CA)</div>
            {% endif %}
        </div>
    </div>

    <!-- Graphique - Inchangé -->
    <div class="chart-container">
        <h2>Évolution du Chiffre d'Affaires</h2>
        <canvas id="revenueChart"></canvas>
    </div>
</div>

<!-- Intégration de Chart.js - Inchangé -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Logique pour le formulaire de filtre (inchangée) ---
    const periodSelect = document.getElementById('period-select');
    const customDateRange = document.getElementById('custom-date-range');
    periodSelect.addEventListener('change', function() {
        customDateRange.style.display = (this.value === 'custom') ? 'flex' : 'none';
    });

    // --- Configuration du graphique (inchangée, utilise votre style de gradient) ---
    const ctx = document.getElementById('revenueChart').getContext('2d');
    const chartLabels = {{ chart_labels|tojson|safe }};
    const chartData = {{ chart_data|tojson|safe }};

    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(79, 195, 247, 0.6)');
    gradient.addColorStop(1, 'rgba(25, 118, 210, 0.1)');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartLabels,
            datasets: [{
                label: 'Chiffre d\'Affaires (XOF)',
                data: chartData,
                backgroundColor: gradient,
                borderColor: '#4FC3F7',
                borderWidth: 3,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#1976D2',
                pointHoverBackgroundColor: '#1976D2',
                pointHoverBorderColor: '#fff',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { color: '#E8F1FA' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                x: { ticks: { color: '#E8F1FA' }, grid: { display: false } }
            },
            plugins: { legend: { display: false } }
        }
    });
});
</script>
{% endblock %}
