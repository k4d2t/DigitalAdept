{% extends "admin_base.html" %}

{% block admin_title %}
    Gestion des Utilisateurs
{% endblock %}

{% block admin_content %}
<div class="settings-page">
    <nav class="admin-nav">
        <a href="{{ url_for('admin_settings') }}" id="retour">← Retour aux paramètres</a>
    </nav>
    <h1>Gestion des Utilisateurs</h1>

    <div class="table-responsive-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Nom d'utilisateur</th>
                    <th>Rôle</th>
                    <th>Commission (%)</th>
                    <th style="width: 80px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td data-label="Utilisateur">{{ user.username }}</td>
                    <td data-label="Rôle">{{ user.role.name if user.role else 'N/A' }}</td>
                    <td data-label="Commission">{{ user.revenue_share_percentage }}%</td>
                    <td data-label="Actions" class="actions-column">
                        {# Le super_admin ne peut pas être supprimé #}
                        {% if user.role and user.role.name != 'super_admin' %}
                        <form class="delete-form" method="POST" action="{{ url_for('delete_user', username=user.username) }}" style="display:inline;">
                            <button class="action-btn delete-btn" type="submit" title="Supprimer l'utilisateur">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" style="text-align: center;">Aucun utilisateur trouvé.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <h2 style="margin-top: 2em;">Ajouter un nouvel Utilisateur</h2>
    <form class="form-user" method="POST" action="{{ url_for('admin_settings_users') }}">
        <label>
            Nom d'utilisateur
            <input type="text" name="username" required>
        </label>
        <label>
            Mot de passe
            <input type="password" name="password" required>
        </label>
        <label>
            Rôle
            <select name="role_id" required>
                <option value="" disabled selected>-- Choisir un rôle --</option>
                {# CORRECTION : Boucle sur les rôles passés depuis la route #}
                {% for role in roles %}
                <option value="{{ role.id }}">{{ role.name }}</option>
                {% endfor %}
            </select>
        </label>
        <label>
            Pourcentage de commission sur le CA (%)
            <input type="number" name="revenue_share" min="0" max="100" step="0.1" value="0" required>
        </label>
        <button type="submit" class="cta">Ajouter</button>
    </form>
</div>

<script>
document.querySelectorAll('.delete-form').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        ConfirmModal(
            'Voulez-vous vraiment supprimer cet utilisateur ?',
            'Oui, supprimer',
            'Annuler',
            () => {
                form.submit();
            }
        );
    });
});
</script>
{% endblock %}
