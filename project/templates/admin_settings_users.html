{% extends "admin_base.html" %}

{% block admin_title %}
    Gestion des Utilisateurs
{% endblock %}

{% block admin_content %}
<div class="settings-page users-page">
    <nav class="admin-nav">
        <a href="{{ url_for('admin_settings') }}" id="retour">← Retour aux paramètres</a>
    </nav>
    <h1>Gestion des Utilisateurs</h1>

    <div class="table-responsive-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Nom d'utilisateur</th>
                    <th>Rôle</th>
                    <th>Commission (%)</th>
                    <th style="width: 180px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr data-user-id="{{ user.id }}">
                    <td data-label="Utilisateur">
                        <span class="view username">{{ user.username }}</span>
                        <input class="edit username-input" type="text" value="{{ user.username }}" style="display:none; width: 95%;">
                    </td>
                    <td data-label="Rôle">
                        <span class="view role-name">{{ user.role.name if user.role else 'N/A' }}</span>
                        <select class="edit role-select" style="display:none; width:100%;">
                            {% for role in roles %}
                                <option value="{{ role.id }}" {% if user.role and role.id == user.role.id %}selected{% endif %}>{{ role.name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td data-label="Commission">
                        <span class="view share">{{ user.revenue_share_percentage }}%</span>
                        <input class="edit share-input" type="number" min="0" max="100" step="0.1" value="{{ user.revenue_share_percentage }}" style="display:none; width: 95%;">
                    </td>
                    <td data-label="Actions" class="actions-column">
                        <div class="view">
                            <button class="action-btn edit-btn" title="Modifier">
                                ✎
                            </button>
                            {% if user.role and user.role.name != 'super_admin' %}
                            <form class="delete-form" method="POST" action="{{ url_for('delete_user', username=user.username) }}" style="display:inline;">
                                <button class="action-btn delete-btn" type="submit" title="Supprimer">🗑</button>
                            </form>
                            {% endif %}
                        </div>
                        <div class="edit" style="display:none;">
                            <button class="action-btn save-btn" title="Enregistrer">💾</button>
                            <button class="action-btn cancel-btn" title="Annuler">↩</button>
                            <button class="action-btn pwd-btn" title="Changer mot de passe">🔒</button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" style="text-align: center;">Aucun utilisateur trouvé.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <h2 style="margin-top: 2em;">Ajouter un nouvel Utilisateur</h2>
    <form class="form-user" method="POST" action="{{ url_for('admin_settings_users') }}">
        <label>
            Nom d'utilisateur
            <input type="text" name="username" required>
        </label>
        <label>
            Mot de passe
            <input type="password" name="password" required>
        </label>
        <label>
            Rôle
            <select name="role_id" required>
                <option value="" disabled selected>-- Choisir un rôle --</option>
                {% for role in roles %}
                <option value="{{ role.id }}">{{ role.name }}</option>
                {% endfor %}
            </select>
        </label>
        <label>
            Pourcentage de commission sur le CA (%)
            <input type="number" name="revenue_share" min="0" max="100" step="0.1" value="0" required>
        </label>
        <button type="submit" class="cta">Ajouter</button>
    </form>
</div>

<script>
document.querySelectorAll('.delete-form').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        ConfirmModal('Voulez-vous vraiment supprimer cet utilisateur ?', 'Oui, supprimer', 'Annuler', () => form.submit());
    });
});

function toggleRow(tr, editMode) {
    tr.querySelectorAll('.view').forEach(el => el.style.display = editMode ? 'none' : '');
    tr.querySelectorAll('.edit').forEach(el => el.style.display = editMode ? '' : 'none');
}

document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const tr = e.currentTarget.closest('tr');
        toggleRow(tr, true);
    });
});

document.querySelectorAll('.cancel-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const tr = e.currentTarget.closest('tr');
        // reset inputs from view
        tr.querySelector('.username-input').value = tr.querySelector('.view.username').textContent.trim();
        const shareTxt = tr.querySelector('.view.share').textContent.trim().replace('%','');
        tr.querySelector('.share-input').value = shareTxt;
        toggleRow(tr, false);
    });
});

document.querySelectorAll('.save-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
        const tr = e.currentTarget.closest('tr');
        const userId = tr.getAttribute('data-user-id');
        const username = tr.querySelector('.username-input').value.trim();
        const roleId = tr.querySelector('.role-select').value;
        const share = tr.querySelector('.share-input').value;

        try {
            const res = await fetch(`/api/admin/users/${userId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                    username: username,
                    role_id: parseInt(roleId),
                    revenue_share_percentage: parseFloat(share)
                })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message || 'Erreur');
            // Update view
            tr.querySelector('.view.username').textContent = username;
            tr.querySelector('.view.role-name').textContent = tr.querySelector('.role-select').selectedOptions[0].textContent;
            tr.querySelector('.view.share').textContent = `${parseFloat(share)}%`;
            toggleRow(tr, false);
            showNotification('Utilisateur mis à jour', 'success');
        } catch (err) {
            showNotification(err.message || 'Erreur lors de la mise à jour', 'error');
        }
    });
});

document.querySelectorAll('.pwd-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
        const tr = e.currentTarget.closest('tr');
        const userId = tr.getAttribute('data-user-id');

        const newPwd = prompt("Nouveau mot de passe (min 6 caractères):");
        if (!newPwd) return;
        if (newPwd.length < 6) {
            showNotification('Mot de passe trop court', 'error');
            return;
        }
        try {
            const res = await fetch(`/api/admin/users/${userId}/password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ new_password: newPwd })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message || 'Erreur');
            showNotification('Mot de passe mis à jour', 'success');
        } catch (err) {
            showNotification(err.message || 'Erreur mot de passe', 'error');
        }
    });
});
</script>
{% endblock %}
