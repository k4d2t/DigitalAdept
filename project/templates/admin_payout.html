{% extends "admin_base.html" %}
{% block admin_title %}Retrait{% endblock %}

{% block admin_content %}
<div class="settings-page payout-page">
  <nav class="admin-nav">
    <a href="{{ url_for('admin_dashboard') }}">← Retour au tableau de bord</a>
  </nav>
  <h1>Demande de Retrait</h1>

  <div class="payout-wrap">
    <div class="form-user">
      <label>Pays
        <select id="countryCode" required>
          <option value="" disabled selected>-- Choisir un pays --</option>
          <option value="ci">Côte d'Ivoire</option>
          <option value="sn">Sénégal</option>
          <option value="bf">Burkina Faso</option>
          <option value="bj">Bénin</option>
          <option value="tg">Togo</option>
          <option value="ml">Mali</option>
          <option value="cg">Congo Brazzaville</option>
          <option value="cm">Cameroun</option>
          <option value="cd">Congo RDC</option>
          <option value="ga">Gabon</option>
          <option value="gh">Ghana</option>
          <option value="gn">Guinée Conakry</option>
          <option value="gw">Guinée-Bissau</option>
          <option value="ke">Kenya</option>
          <option value="mr">Mauritanie</option>
          <option value="ne">Niger</option>
          <option value="ug">Ouganda</option>
          <option value="cf">Centrafrique</option>
          <option value="rw">Rwanda</option>
          <option value="sl">Sierra Leone</option>
          <option value="tz">Tanzanie</option>
          <option value="td">Tchad</option>
          <option value="gm">Gambie</option>
          <option value="et">Éthiopie</option>
        </select>
      </label>

      <label>Méthode de retrait
        <select id="withdraw_mode" required></select>
      </label>

      <label>Numéro (ex: 05xxxxxxxxx)
        <input type="text" id="phone" placeholder="Numéro Mobile Money" required>
      </label>

      <label>Montant
        <input type="number" id="amount" min="1" step="0.01" placeholder="Montant à retirer" required>
      </label>

      <div class="balance-row" style="margin-top:-.4rem; margin-bottom:.2rem; color: var(--primary-dark);">
        Solde disponible: <strong id="availableBalance">--</strong> XOF
      </div>

      <button class="cta" id="payoutSubmit">Soumettre</button>
      <small style="opacity:.8;">Les retraits sont traités via Money Fusion. Assure-toi que ton IP serveur est autorisée et que la clé API est configurée.</small>
    </div>
  </div>

  <h2 style="margin-top:2rem; text-align:center; color: var(--primary-dark);">Historique des retraits</h2>

  <div class="payout-history">
    <div class="table-responsive-wrapper">
      <table class="payout-history-table" id="payoutHistoryTable">
        <thead>
          <tr>
            <th class="sortable" data-sort="created_at">
              Date
              <span class="sort-arrow"></span>
            </th>
            <th class="sortable" data-sort="external_id">
              Référence
              <span class="sort-arrow"></span>
            </th>
            <th class="sortable" data-sort="amount">
              Montant
              <span class="sort-arrow"></span>
            </th>
            <th class="sortable" data-sort="status">
              Statut
              <span class="sort-arrow"></span>
            </th>
          </tr>
        </thead>
        <tbody id="payoutHistoryBody">
          <tr><td colspan="4" style="text-align:center;">Chargement…</td></tr>
        </tbody>
      </table>
    </div>
    <div style="text-align:center; margin-top: 0.8rem;">
      <button id="loadMoreHistory" class="cta" style="min-width:220px;">Voir plus</button>
    </div>
  </div>
</div>

<script>
const modesByCountry = {
  ci: ['orange-money-ci','mtn-ci','moov-ci','wave-ci'],
  sn: ['orange-money-senegal','free-money-senegal','wave-senegal','expresso-senegal'],
  bf: ['orange-money-burkina','moov-burkina-faso'],
  bj: ['mtn-benin','moov-benin'],
  tg: ['t-money-togo','moov-togo'],
  ml: ['orange-money-mali'],
  cg: ['orange-money-mali','mtn-cg'],
  cm: ['orange-money-cm','mtn-cm'],
  cd: ['airtel-money-cd'],
  ga: ['airtel-money-ga','libertis-ga'],
  gh: ['airtel-money-gh','mtn-gh','vodafone-gh'],
  gn: ['orange-gn','mtn-gn'],
  gw: ['mtn-gw'],
  ke: ['m-pesa-ke'],
  mr: ['bankily-mr'],
  ne: ['airtel-money-ne','mtn-ne','mauritel-ne'],
  ug: ['mtn-ug'],
  cf: ['orange-cf'],
  rw: ['mtn-rw'],
  sl: ['africell-sl','orange-sl'],
  tz: ['airtel-money-tz','m-pesa-tz','tigo-tz'],
  td: ['airtel-money-td','moov-td'],
  gm: ['orange-gm'],
  et: ['safaricom-et'],
};

let AVAILABLE_BALANCE = 0;

// Payout form helpers
function refreshModes() {
  const cc = document.getElementById('countryCode').value;
  const sel = document.getElementById('withdraw_mode');
  sel.innerHTML = '';
  (modesByCountry[cc] || []).forEach(m => {
    const opt = document.createElement('option');
    opt.value = m; opt.textContent = m;
    sel.appendChild(opt);
  });
}

async function loadBalance() {
  try {
    const res = await fetch('/api/payout/balance', { credentials: 'same-origin' });
    const data = await res.json();
    if (res.ok && data.status === 'success') {
      AVAILABLE_BALANCE = +data.available || 0;
      document.getElementById('availableBalance').textContent = AVAILABLE_BALANCE.toLocaleString('fr-FR');
      validateAmount();
    } else {
      document.getElementById('availableBalance').textContent = '--';
    }
  } catch {
    document.getElementById('availableBalance').textContent = '--';
  }
}

function validateAmount() {
  const amountEl = document.getElementById('amount');
  const btn = document.getElementById('payoutSubmit');
  const val = parseFloat(amountEl.value || '0');
  const invalid = isNaN(val) || val <= 0 || val > AVAILABLE_BALANCE;
  amountEl.classList.toggle('input-error', invalid);
  btn.disabled = invalid;
  return !invalid;
}

// History sorting/pagination state
const HISTORY_PAGE_SIZE = 10;
let histSortBy = 'created_at';
let histSortDir = 'desc';
let histNextOffset = 0;
let histHasMore = true;

function statusClass(s) {
  s = (s || '').toLowerCase();
  if (s === 'completed') return 'status-completed';
  if (s === 'pending') return 'status-pending';
  if (s === 'failed') return 'status-failed';
  if (s === 'cancelled') return 'status-cancelled';
  return 'status-unknown';
}
function statusLabel(s) {
  if (!s) return '—';
  s = String(s);
  return s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
}

async function fetchHistoryPage(offset, append) {
  const tbody = document.getElementById('payoutHistoryBody');
  const btn = document.getElementById('loadMoreHistory');
  btn.disabled = true;

  try {
    const url = new URL('/api/payout/history', window.location.origin);
    url.searchParams.set('limit', HISTORY_PAGE_SIZE);
    url.searchParams.set('offset', offset);
    url.searchParams.set('sort_by', histSortBy);
    url.searchParams.set('sort_dir', histSortDir);

    const res = await fetch(url, { credentials: 'same-origin' });
    const data = await res.json();
    if (!res.ok || data.status !== 'success') throw new Error();

    const items = data.items || [];
    if (!append) {
      tbody.innerHTML = '';
    }
    if (items.length === 0 && !append) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Aucun retrait pour le moment.</td></tr>';
    } else {
      const rowsHtml = items.map(it => {
        const amount = `${Number(it.amount || 0).toLocaleString('fr-FR')} ${it.currency || 'XOF'}`;
        const ref = it.reference_short || it.reference || '—';
        const st = it.status || '';
        return `<tr>
          <td data-label="Date">${it.date}</td>
          <td data-label="Référence" title="${it.reference || ''}"><span class="ref-chip">${ref}</span></td>
          <td data-label="Montant"><span class="amount-chip">${amount}</span></td>
          <td data-label="Statut"><span class="status-badge ${statusClass(st)}">${statusLabel(st)}</span></td>
        </tr>`;
      }).join('');
      if (append) {
        tbody.insertAdjacentHTML('beforeend', rowsHtml);
      } else {
        tbody.innerHTML = rowsHtml;
      }
    }

    histHasMore = !!data.has_more;
    histNextOffset = data.next_offset || (offset + items.length);
    btn.style.display = histHasMore ? 'inline-block' : 'none';
  } catch {
    if (!append) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Erreur de chargement.</td></tr>';
    }
    btn.style.display = 'inline-block';
  } finally {
    btn.disabled = !histHasMore;
  }
}

function resetAndLoadHistory() {
  histNextOffset = 0;
  histHasMore = true;
  fetchHistoryPage(0, /*append*/ false);
}

function setupSortHeaders() {
  const ths = document.querySelectorAll('#payoutHistoryTable th.sortable');
  ths.forEach(th => {
    th.addEventListener('click', () => {
      const col = th.getAttribute('data-sort');
      if (col === histSortBy) {
        histSortDir = (histSortDir === 'asc') ? 'desc' : 'asc';
      } else {
        histSortBy = col;
        histSortDir = 'desc'; // par défaut
      }
      // UI arrows
      ths.forEach(x => x.classList.remove('sorted-asc', 'sorted-desc'));
      th.classList.add(histSortDir === 'asc' ? 'sorted-asc' : 'sorted-desc');
      resetAndLoadHistory();
    });
  });
}

document.addEventListener('DOMContentLoaded', () => {
  const cc = document.getElementById('countryCode');
  if (cc) { cc.value = 'ci'; refreshModes(); }
  loadBalance();
  setupSortHeaders();
  resetAndLoadHistory();

  document.getElementById('countryCode').addEventListener('change', refreshModes);
  document.getElementById('amount').addEventListener('input', validateAmount);
  document.getElementById('loadMoreHistory').addEventListener('click', () => {
    if (histHasMore) fetchHistoryPage(histNextOffset, /*append*/ true);
  });
});

document.getElementById('payoutSubmit').addEventListener('click', async () => {
  if (!validateAmount()) { showNotification('Montant invalide (dépasse le solde dispo).', 'error'); return; }
  const payload = {
    countryCode: document.getElementById('countryCode').value,
    withdraw_mode: document.getElementById('withdraw_mode').value,
    phone: document.getElementById('phone').value.trim(),
    amount: document.getElementById('amount').value
  };
  if (!payload.countryCode || !payload.withdraw_mode || !payload.phone) {
    showNotification('Veuillez compléter tous les champs.', 'error'); return;
  }
  try {
    const res = await fetch('/api/payout/withdraw', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      credentials: 'same-origin',
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!res.ok || data.statut === false) {
      showNotification(data.message || 'Erreur lors de la demande de retrait.', 'error');
    } else {
      showNotification('Retrait soumis: ' + (data.message || 'succès.'), 'success');
      // Mise à jour solde et historique (on repart de la page 1, tri courant)
      loadBalance();
      resetAndLoadHistory();
      document.getElementById('amount').value = '';
      validateAmount();
    }
  } catch {
    showNotification('Erreur réseau, réessayez.', 'error');
  }
});
</script>
{% endblock %}
